# ä¼ä¸šæ™ºèƒ½å®¢æœç³»ç»Ÿ - åç«¯å¼€å‘æŠ€æœ¯æ–¹æ¡ˆ

<div align="center">

![Python](https://img.shields.io/badge/Python-3.10+-3776ab.svg?logo=python)
![FastAPI](https://img.shields.io/badge/FastAPI-0.115+-009688.svg?logo=fastapi)
![Haystack](https://img.shields.io/badge/Haystack-2.x-FF6B6B.svg)
![Ollama](https://img.shields.io/badge/Ollama-Latest-000000.svg)
![PostgreSQL](https://img.shields.io/badge/PostgreSQL-15+-336791.svg?logo=postgresql)

**åŸºäº Haystack 2 + Ollama + Hybrid æ£€ç´¢ + å¼ºé‡æ’çš„ä¼ä¸šçº§ RAG æ–¹æ¡ˆ**

</div>

---

## ğŸ“‹ ç›®å½•

- [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
- [2. åŠŸèƒ½æ¨¡å—è¯¦ç»†æ¢³ç†](#2-åŠŸèƒ½æ¨¡å—è¯¦ç»†æ¢³ç†)
- [3. æ ¸å¿ƒæŠ€æœ¯é€‰å‹](#3-æ ¸å¿ƒæŠ€æœ¯é€‰å‹)
- [4. RAG æŠ€æœ¯æ¶æ„](#4-rag-æŠ€æœ¯æ¶æ„)
- [5. å¼€å‘è·¯çº¿è§„åˆ’](#5-å¼€å‘è·¯çº¿è§„åˆ’)
- [6. æ•°æ®åº“è®¾è®¡](#6-æ•°æ®åº“è®¾è®¡)
- [7. éƒ¨ç½²æ¶æ„](#7-éƒ¨ç½²æ¶æ„)
- [8. å®‰å…¨ä¸æ€§èƒ½](#8-å®‰å…¨ä¸æ€§èƒ½)
- [9. ç›‘æ§ä¸è¿ç»´](#9-ç›‘æ§ä¸è¿ç»´)
- [10. é™„å½•](#10-é™„å½•)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

ä¼ä¸šæ™ºèƒ½å®¢æœç³»ç»Ÿåç«¯æ˜¯ä¸€ä¸ª**è½»é‡çº§ã€ç§æœ‰åŒ–éƒ¨ç½²**çš„ AI é—®ç­”æœåŠ¡ï¼Œé¢å‘ä¼ä¸šå†…éƒ¨ç”¨æˆ·æä¾›ï¼š
- åŸºäºçŸ¥è¯†åº“çš„æ™ºèƒ½é—®ç­”ï¼ˆRAGï¼‰
- ç»“æ„åŒ–æ•°æ®æŸ¥è¯¢ï¼ˆMySQL ä¸­é—´å±‚ï¼‰
- éƒ¨é—¨çº§æ•°æ®æƒé™éš”ç¦»
- ç®¡ç†åå°æ”¯æ’‘åŠŸèƒ½

### 1.2 æ ¸å¿ƒç‰¹æ€§

- âœ… **æœ¬åœ°ç§æœ‰éƒ¨ç½²**ï¼šå…¨å¼€æºæŠ€æœ¯æ ˆï¼Œæ— å¤–éƒ¨ä¾èµ–
- âœ… **ç¨³å¥ RAG åŸºçº¿**ï¼šHybrid æ£€ç´¢ + Cross-Encoder é‡æ’
- âœ… **æŒ‰éœ€å¢å¼ºå¬å›**ï¼šç–‘éš¾é—®é¢˜è§¦å‘ Multi-Query/HyDE
- âœ… **æ•°æ®å®‰å…¨**ï¼šéƒ¨é—¨çº§éš”ç¦» + SQL æ³¨å…¥é˜²æŠ¤ + å®¡è®¡æ—¥å¿—
- âœ… **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„é“¾è·¯è¿½è¸ªä¸æ€§èƒ½æŒ‡æ ‡
- âœ… **æ˜“æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼ŒåæœŸå¯å¹³æ»‘è¿ç§»æ‰©å®¹

### 1.3 æŠ€æœ¯çº¦æŸ

- **éƒ¨ç½²ç¯å¢ƒ**ï¼šæœ¬åœ°æœåŠ¡å™¨ï¼ˆåˆæœŸå•æœºï¼ŒåæœŸå¯åˆ†å¸ƒå¼ï¼‰
- **æ¨¡å‹è¿è¡Œ**ï¼šç¦»çº¿æ¨ç†ï¼ˆOllamaï¼‰
- **å“åº”è¦æ±‚**ï¼šP95 å»¶è¿Ÿ < 3sï¼ˆå«ç”Ÿæˆï¼‰
- **å¹¶å‘èƒ½åŠ›**ï¼šåˆæœŸ 10-20 QPSï¼Œé¢„ç•™æ‰©å±•ç©ºé—´
- **å­˜å‚¨å®¹é‡**ï¼šçŸ¥è¯†åº“åˆæœŸ < 10GBï¼Œé¢„ç•™ 100GB

---

## 2. åŠŸèƒ½æ¨¡å—è¯¦ç»†æ¢³ç†

### 2.1 æ¨¡å—æ€»è§ˆ

| æ¨¡å— | ä¼˜å…ˆçº§ | å¤æ‚åº¦ | å¼€å‘å‘¨æœŸ | ä¾èµ–å…³ç³» |
|------|--------|--------|----------|----------|
| **è®¤è¯é‰´æƒ** | P0 | ä½ | 2å¤© | æ—  |
| **æ™ºèƒ½å¯¹è¯ï¼ˆRAGï¼‰** | P0 | é«˜ | 10å¤© | è®¤è¯ã€çŸ¥è¯†åº“ |
| **çŸ¥è¯†åº“ç®¡ç†** | P0 | ä¸­ | 5å¤© | è®¤è¯ |
| **MySQL é…ç½®ä¸æŸ¥è¯¢** | P1 | ä¸­ | 4å¤© | è®¤è¯ã€æƒé™ |
| **æ•°æ®æƒé™ç®¡ç†** | P1 | ä¸­ | 3å¤© | è®¤è¯ |
| **ç”¨æˆ·ä¸è§’è‰²ç®¡ç†** | P1 | ä½ | 2å¤© | è®¤è¯ |
| **æ™ºèƒ½é…ç½®ï¼ˆæ„å›¾/åŒä¹‰è¯ï¼‰** | P2 | ä¸­ | 3å¤© | è®¤è¯ |
| **æ•°æ®ç»Ÿè®¡åˆ†æ** | P2 | ä½ | 3å¤© | è®¤è¯ |
| **ç³»ç»Ÿé…ç½®** | P2 | ä½ | 2å¤© | è®¤è¯ |

> **å¼€å‘æ€»è®¡**ï¼šçº¦ 34 äººå¤©ï¼ˆçº¦ 7 å‘¨ï¼Œ1 äººå…¨èŒï¼‰

---

### 2.2 æ¨¡å—è¯¦ç»†è¯´æ˜

#### 2.2.1 è®¤è¯é‰´æƒæ¨¡å—ï¼ˆP0ï¼Œ2å¤©ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- ç”¨æˆ·ç™»å½•ï¼ˆè´¦å·å¯†ç ï¼‰
- JWT Token ç­¾å‘ä¸éªŒè¯
- Token åˆ·æ–°æœºåˆ¶
- ç™»å‡ºï¼ˆToken å¤±æ•ˆï¼‰
- ä¸­é—´ä»¶ï¼šè·¯ç”±é‰´æƒ

**æ¥å£æ¸…å•**ï¼š
```
POST   /api/auth/login        # ç™»å½•
POST   /api/auth/logout       # ç™»å‡º
GET    /api/auth/verify       # éªŒè¯ Token
POST   /api/auth/refresh      # åˆ·æ–° Token
```

**æ ¸å¿ƒé€»è¾‘**ï¼š
- å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨
- JWT Payload åŒ…å«ï¼šuser_idã€usernameã€roleã€exp
- Token æœ‰æ•ˆæœŸï¼š2 å°æ—¶ï¼ˆå¯é…ç½®ï¼‰
- Refresh Token æœ‰æ•ˆæœŸï¼š7 å¤©

**æ•°æ®è¡¨**ï¼š
- `users`ï¼ˆç”¨æˆ·è¡¨ï¼‰
- `login_logs`ï¼ˆç™»å½•æ—¥å¿—ï¼‰

---

#### 2.2.2 æ™ºèƒ½å¯¹è¯æ¨¡å—ï¼ˆP0ï¼Œ10å¤©ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯ï¼Œè°ƒç”¨ RAG æµç¨‹
- Hybrid æ£€ç´¢ï¼ˆBM25 + å‘é‡ï¼‰
- Cross-Encoder é‡æ’
- ç–‘éš¾é—®é¢˜è§¦å‘ Multi-Query/HyDEï¼ˆç°åº¦ï¼‰
- LLM ç”Ÿæˆå›ç­”ï¼ˆæºå¸¦å¼•ç”¨ï¼‰
- å¯¹è¯å†å²ç®¡ç†
- ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†

**æ¥å£æ¸…å•**ï¼š
```
POST   /api/chat/message            # å‘é€æ¶ˆæ¯
GET    /api/chat/conversations      # è·å–å¯¹è¯åˆ—è¡¨
GET    /api/chat/conversation/:id   # è·å–å¯¹è¯è¯¦æƒ…
DELETE /api/chat/conversation/:id   # åˆ é™¤å¯¹è¯
POST   /api/chat/feedback           # ç”¨æˆ·åé¦ˆï¼ˆç‚¹èµ/ç‚¹è¸©ï¼‰
```

**æ ¸å¿ƒ RAG æµç¨‹**ï¼ˆè¯¦è§ 4.RAG æŠ€æœ¯æ¶æ„ï¼‰ï¼š
1. ç”¨æˆ·è¾“å…¥é¢„å¤„ç†ï¼ˆæ„å›¾è¯†åˆ«ã€å®ä½“æå–ï¼‰
2. åˆ¤æ–­æ˜¯å¦è§¦å‘ Multi-Query/HyDEï¼ˆä½ç½®ä¿¡åº¦/ç‰¹å®šæ„å›¾ï¼‰
3. Hybrid æ£€ç´¢ï¼ˆBM25 + å‘é‡ï¼Œå„ Top-20ï¼‰
4. RRF èåˆ + Cross-Encoder é‡æ’ï¼ˆTop-8ï¼‰
5. æ„å»º Promptï¼ˆæºå¸¦å¼•ç”¨ç‰‡æ®µï¼‰
6. LLM ç”Ÿæˆå›ç­”
7. åå¤„ç†ï¼ˆå¼•ç”¨æ ‡æ³¨ã€æ•æ„Ÿè¯è¿‡æ»¤ï¼‰
8. ä¿å­˜å¯¹è¯è®°å½•ä¸åé¦ˆ

**æ•°æ®è¡¨**ï¼š
- `conversations`ï¼ˆå¯¹è¯ä¼šè¯ï¼‰
- `messages`ï¼ˆæ¶ˆæ¯è®°å½•ï¼‰
- `feedback`ï¼ˆç”¨æˆ·åé¦ˆï¼‰
- `retrieval_logs`ï¼ˆæ£€ç´¢æ—¥å¿—ï¼Œç”¨äºä¼˜åŒ–ï¼‰

---

#### 2.2.3 çŸ¥è¯†åº“ç®¡ç†æ¨¡å—ï¼ˆP0ï¼Œ5å¤©ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- çŸ¥è¯†æ¡ç›® CRUD
- å¤šæ ¼å¼æ–‡æ¡£ä¸Šä¼ ï¼ˆPDFã€DOCXã€PPTXã€MDã€TXTã€CSVã€XLSXï¼‰
- æ–‡æ¡£è§£æä¸æ¸…æ´—
- åˆ†å—ï¼ˆChunkingï¼‰
- å‘é‡åŒ–ï¼ˆEmbeddingï¼‰
- å†™å…¥å‘é‡åº“ï¼ˆQdrantï¼‰+ BM25 ç´¢å¼•ï¼ˆOpenSearchï¼‰
- æ‰¹é‡å¯¼å‡º
- ç‰ˆæœ¬ç®¡ç†

**æ¥å£æ¸…å•**ï¼š
```
GET    /api/knowledge/list           # è·å–çŸ¥è¯†åˆ—è¡¨ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
POST   /api/knowledge/add            # æ–°å¢çŸ¥è¯†
GET    /api/knowledge/:id            # è·å–çŸ¥è¯†è¯¦æƒ…
PUT    /api/knowledge/:id            # æ›´æ–°çŸ¥è¯†
DELETE /api/knowledge/:id            # åˆ é™¤çŸ¥è¯†
POST   /api/knowledge/import         # æ‰¹é‡å¯¼å…¥æ–‡æ¡£
GET    /api/knowledge/export         # æ‰¹é‡å¯¼å‡º
GET    /api/knowledge/preview/:id    # é¢„è§ˆçŸ¥è¯†
POST   /api/knowledge/reindex        # é‡å»ºç´¢å¼•
```

**æ–‡æ¡£å¤„ç†æµç¨‹**ï¼š
```
ä¸Šä¼ æ–‡ä»¶ â†’ æ ¼å¼è¯†åˆ« â†’ æ–‡æœ¬æå–ï¼ˆUnstructured/PyPDF2/python-docxï¼‰
  â†’ æ¸…æ´—ï¼ˆå»é¡µçœ‰é¡µè„š/æ°´å°/ç›®å½•ï¼‰ â†’ åˆ†å—ï¼ˆ350-500 tokens, overlap 50-100ï¼‰
  â†’ Embeddingï¼ˆbge-m3ï¼‰ â†’ å†™å…¥ Qdrant + OpenSearch â†’ å…ƒæ•°æ®å…¥åº“ï¼ˆPostgreSQLï¼‰
```

**æ•°æ®è¡¨**ï¼š
- `knowledge_base`ï¼ˆçŸ¥è¯†æ¡ç›®å…ƒæ•°æ®ï¼‰
- `knowledge_chunks`ï¼ˆåˆ†å—è®°å½•ï¼Œç”¨äºæº¯æºï¼‰
- `knowledge_versions`ï¼ˆç‰ˆæœ¬å†å²ï¼‰

---

#### 2.2.4 MySQL é…ç½®ä¸æŸ¥è¯¢æ¨¡å—ï¼ˆP1ï¼Œ4å¤©ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- SQL è¯­å¥æ¨¡æ¿ç®¡ç†ï¼ˆå‚æ•°åŒ–ï¼Œ`{{å˜é‡}}` è¯­æ³•ï¼‰
- å‚æ•°æ ¡éªŒä¸ç±»å‹è½¬æ¢
- æ‰§è¡Œ SQLï¼ˆåªè¯»è´¦å·ï¼Œé˜²æ³¨å…¥ï¼‰
- ç»“æœè„±æ•ï¼ˆæ‰‹æœºå·ã€èº«ä»½è¯ï¼‰
- ä¸éƒ¨é—¨æƒé™ç»‘å®šï¼ˆè¡Œçº§è¿‡æ»¤ï¼‰
- æ‰§è¡Œæ—¥å¿—è®°å½•

**æ¥å£æ¸…å•**ï¼š
```
GET    /api/mysql/statements         # è·å– SQL åˆ—è¡¨
POST   /api/mysql/statements         # æ–°å¢ SQL æ¨¡æ¿
GET    /api/mysql/statements/:id     # è·å– SQL è¯¦æƒ…
PUT    /api/mysql/statements/:id     # æ›´æ–° SQL æ¨¡æ¿
DELETE /api/mysql/statements/:id     # åˆ é™¤ SQL æ¨¡æ¿
POST   /api/mysql/test               # æµ‹è¯• SQLï¼ˆéœ€å‚æ•°ï¼‰
POST   /api/mysql/execute            # æ‰§è¡Œ SQLï¼ˆæ™ºèƒ½å¯¹è¯è°ƒç”¨ï¼‰
GET    /api/mysql/logs               # æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
```

**å®‰å…¨æœºåˆ¶**ï¼š
- SQL ç™½åå•ï¼ˆåªå…è®¸ SELECTï¼‰
- å‚æ•°ç±»å‹ä¸¥æ ¼æ ¡éªŒï¼ˆé˜²æ³¨å…¥ï¼‰
- åªè¯»è´¦å·è¿æ¥ï¼ˆread-only userï¼‰
- éƒ¨é—¨æƒé™è¿‡æ»¤ï¼ˆè‡ªåŠ¨æ³¨å…¥ WHERE æ¡ä»¶ï¼‰
- ç»“æœæ•æ„Ÿæ•°æ®è„±æ•ï¼ˆæ­£åˆ™æ›¿æ¢ï¼‰

**æ•°æ®è¡¨**ï¼š
- `sql_templates`ï¼ˆSQL æ¨¡æ¿ï¼‰
- `sql_execution_logs`ï¼ˆæ‰§è¡Œæ—¥å¿—ï¼‰
- `sql_department_bindings`ï¼ˆSQL ä¸éƒ¨é—¨ç»‘å®šå…³ç³»ï¼‰

---

#### 2.2.5 æ•°æ®æƒé™ç®¡ç†æ¨¡å—ï¼ˆP1ï¼Œ3å¤©ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- éƒ¨é—¨ä¿¡æ¯ç»´æŠ¤ï¼ˆæ ‘å½¢ç»“æ„ï¼‰
- SQL è¯­å¥ä¸éƒ¨é—¨ç»‘å®š
- ç”¨æˆ·ä¸éƒ¨é—¨å…³è”
- æƒé™å®¡è®¡æ—¥å¿—

**æ¥å£æ¸…å•**ï¼š
```
GET    /api/permission/departments          # è·å–éƒ¨é—¨åˆ—è¡¨ï¼ˆæ ‘å½¢ï¼‰
POST   /api/permission/departments          # æ–°å¢éƒ¨é—¨
PUT    /api/permission/departments/:id      # æ›´æ–°éƒ¨é—¨
DELETE /api/permission/departments/:id      # åˆ é™¤éƒ¨é—¨
GET    /api/permission/bindings             # è·å–æƒé™ç»‘å®šåˆ—è¡¨
POST   /api/permission/bindings             # ç»‘å®š SQL åˆ°éƒ¨é—¨
GET    /api/permission/audit-logs           # æƒé™å®¡è®¡æ—¥å¿—
```

**æƒé™æ§åˆ¶é€»è¾‘**ï¼š
- ç”¨æˆ·ç™»å½•åï¼ŒToken ä¸­æºå¸¦ `department_id`
- æŸ¥è¯¢çŸ¥è¯†åº“æ—¶ï¼Œä»…è¿”å›è¯¥éƒ¨é—¨å¯è§çš„çŸ¥è¯†
- æ‰§è¡Œ SQL æ—¶ï¼Œè‡ªåŠ¨æ³¨å…¥éƒ¨é—¨è¿‡æ»¤æ¡ä»¶
- è·¨éƒ¨é—¨è®¿é—®å°è¯•è®°å½•å®¡è®¡æ—¥å¿—

**æ•°æ®è¡¨**ï¼š
- `departments`ï¼ˆéƒ¨é—¨è¡¨ï¼‰
- `user_department_bindings`ï¼ˆç”¨æˆ·éƒ¨é—¨å…³è”ï¼‰
- `permission_audit_logs`ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰

---

#### 2.2.6 ç”¨æˆ·ä¸è§’è‰²ç®¡ç†æ¨¡å—ï¼ˆP1ï¼Œ2å¤©ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- ç®¡ç†å‘˜è´¦å· CRUD
- è§’è‰²å®šä¹‰ï¼ˆè¶…çº§ç®¡ç†å‘˜ã€æ™®é€šç®¡ç†å‘˜ã€åªè¯»ç”¨æˆ·ï¼‰
- è§’è‰²æƒé™é…ç½®ï¼ˆæ¨¡å—çº§ï¼‰
- å¯†ç é‡ç½®
- æ“ä½œæ—¥å¿—

**æ¥å£æ¸…å•**ï¼š
```
GET    /api/users/admins             # è·å–ç®¡ç†å‘˜åˆ—è¡¨
POST   /api/users/admins             # æ–°å¢ç®¡ç†å‘˜
GET    /api/users/admins/:id         # è·å–ç®¡ç†å‘˜è¯¦æƒ…
PUT    /api/users/admins/:id         # æ›´æ–°ç®¡ç†å‘˜
DELETE /api/users/admins/:id         # åˆ é™¤ç®¡ç†å‘˜
POST   /api/users/admins/:id/reset-password  # é‡ç½®å¯†ç 
GET    /api/users/roles              # è·å–è§’è‰²åˆ—è¡¨
POST   /api/users/roles              # æ–°å¢è§’è‰²
PUT    /api/users/roles/:id          # æ›´æ–°è§’è‰²
DELETE /api/users/roles/:id          # åˆ é™¤è§’è‰²
POST   /api/users/assign-role        # åˆ†é…è§’è‰²
GET    /api/users/login-logs         # è·å–ç™»å½•æ—¥å¿—
```

**è§’è‰²æƒé™çŸ©é˜µ**ï¼ˆç¤ºä¾‹ï¼‰ï¼š
| è§’è‰² | çŸ¥è¯†åº“ç®¡ç† | MySQL é…ç½® | ç”¨æˆ·ç®¡ç† | æ•°æ®ç»Ÿè®¡ |
|------|------------|------------|----------|----------|
| **è¶…çº§ç®¡ç†å‘˜** | âœ… | âœ… | âœ… | âœ… |
| **æ™®é€šç®¡ç†å‘˜** | âœ… | âœ… | âŒ | âœ… |
| **åªè¯»ç”¨æˆ·** | æŸ¥çœ‹ | æŸ¥çœ‹ | âŒ | æŸ¥çœ‹ |

**æ•°æ®è¡¨**ï¼š
- `users`ï¼ˆç”¨æˆ·è¡¨ï¼‰
- `roles`ï¼ˆè§’è‰²è¡¨ï¼‰
- `role_permissions`ï¼ˆè§’è‰²æƒé™ï¼‰
- `user_roles`ï¼ˆç”¨æˆ·è§’è‰²å…³è”ï¼‰

---

#### 2.2.7 æ™ºèƒ½é…ç½®æ¨¡å—ï¼ˆP2ï¼Œ3å¤©ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- æ„å›¾æ ‡ç­¾ç®¡ç†
- åŒä¹‰è¯/å˜ä½“é…ç½®
- é—®ç­”è§„åˆ™ï¼ˆå…³é”®è¯ã€æ­£åˆ™ï¼‰
- ä¼˜å…ˆçº§ä¸çŠ¶æ€ç®¡ç†
- è§„åˆ™æµ‹è¯•

**æ¥å£æ¸…å•**ï¼š
```
GET    /api/intelligent/intents          # è·å–æ„å›¾åˆ—è¡¨
POST   /api/intelligent/intents          # æ–°å¢æ„å›¾
PUT    /api/intelligent/intents/:id      # æ›´æ–°æ„å›¾
DELETE /api/intelligent/intents/:id      # åˆ é™¤æ„å›¾
GET    /api/intelligent/rules            # è·å–é—®ç­”è§„åˆ™åˆ—è¡¨
POST   /api/intelligent/rules            # æ–°å¢é—®ç­”è§„åˆ™
POST   /api/intelligent/test             # æµ‹è¯•æ„å›¾è¯†åˆ«
```

**æ•°æ®è¡¨**ï¼š
- `intents`ï¼ˆæ„å›¾è¡¨ï¼‰
- `synonyms`ï¼ˆåŒä¹‰è¯ï¼‰
- `qa_rules`ï¼ˆé—®ç­”è§„åˆ™ï¼‰

---

#### 2.2.8 æ•°æ®ç»Ÿè®¡åˆ†ææ¨¡å—ï¼ˆP2ï¼Œ3å¤©ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- æ ¸å¿ƒæŒ‡æ ‡çœ‹æ¿ï¼ˆæŸ¥è¯¢é‡ã€å“åº”æ—¶é—´ã€è§£å†³ç‡ã€å‡†ç¡®ç‡ï¼‰
- åŠ¨æ€æ—¶é—´ç­›é€‰ï¼ˆä»Šæ—¥ã€æœ¬å‘¨ã€æœ¬æœˆã€è‡ªå®šä¹‰ï¼‰
- æœªè¯†åˆ«é—®é¢˜ TOP10
- SQL å¤±è´¥è®°å½•
- éƒ¨é—¨æŸ¥è¯¢ç»Ÿè®¡
- æŠ¥è¡¨å¯¼å‡ºï¼ˆCSV/Excelï¼‰

**æ¥å£æ¸…å•**ï¼š
```
GET    /api/analytics/dashboard                # æ•°æ®çœ‹æ¿
GET    /api/analytics/metrics                  # æ ¸å¿ƒæŒ‡æ ‡
GET    /api/analytics/unrecognized-questions   # æœªè¯†åˆ«é—®é¢˜TOP10
GET    /api/analytics/sql-failures             # SQL å¤±è´¥è®°å½•
GET    /api/analytics/department-stats         # éƒ¨é—¨ç»Ÿè®¡
POST   /api/analytics/export                   # å¯¼å‡ºæŠ¥è¡¨
```

**æ•°æ®è¡¨**ï¼š
- å¤ç”¨ `messages`ã€`feedback`ã€`sql_execution_logs` ç­‰è¡¨
- å¯é€‰ï¼š`analytics_snapshots`ï¼ˆå®šæ—¶å¿«ç…§ï¼ŒåŠ é€ŸæŸ¥è¯¢ï¼‰

---

#### 2.2.9 ç³»ç»Ÿé…ç½®æ¨¡å—ï¼ˆP2ï¼Œ2å¤©ï¼‰

**åŠŸèƒ½èŒƒå›´**ï¼š
- åŸºç¡€ä¿¡æ¯è®¾ç½®ï¼ˆä¼ä¸šåç§°ã€ç³»ç»Ÿåç§°ï¼‰
- æ¥å£é…ç½®ï¼ˆä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€OAï¼‰
- é€šçŸ¥è§„åˆ™é…ç½®
- ç³»ç»Ÿæ—¥å¿—ç®¡ç†

**æ¥å£æ¸…å•**ï¼š
```
GET    /api/system/config                # è·å–ç³»ç»Ÿé…ç½®
PUT    /api/system/config                # æ›´æ–°ç³»ç»Ÿé…ç½®
POST   /api/system/config/test-connection # æµ‹è¯•ç¬¬ä¸‰æ–¹æ¥å£
GET    /api/system/notifications         # è·å–é€šçŸ¥è§„åˆ™
POST   /api/system/notifications         # æ–°å¢é€šçŸ¥è§„åˆ™
PUT    /api/system/notifications/:id     # æ›´æ–°é€šçŸ¥è§„åˆ™
DELETE /api/system/notifications/:id     # åˆ é™¤é€šçŸ¥è§„åˆ™
GET    /api/system/logs                  # æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
GET    /api/health                       # å¥åº·æ£€æŸ¥
GET    /api/metrics                      # PrometheusæŒ‡æ ‡
```

**æ•°æ®è¡¨**ï¼š
- `system_config`ï¼ˆç³»ç»Ÿé…ç½®ï¼ŒKV ç»“æ„ï¼‰
- `system_logs`ï¼ˆç³»ç»Ÿæ—¥å¿—ï¼‰

---

## 3. æ ¸å¿ƒæŠ€æœ¯é€‰å‹

### 3.1 æ€»ä½“æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|----------|------|------|
| **ç¼–ç¨‹è¯­è¨€** | Python | 3.10+ | RAG ç”Ÿæ€æˆç†Ÿ |
| **Web æ¡†æ¶** | FastAPI | 0.115+ | é«˜æ€§èƒ½å¼‚æ­¥æ¡†æ¶ |
| **RAG æ¡†æ¶** | Haystack 2 | 2.1.0+ | å·¥ä¸šçº§ç®¡çº¿ã€å¯è§‚æµ‹æ€§å¼º |
| **å¤§æ¨¡å‹æ¨ç†** | Ollama | Latest | æœ¬åœ°ç¦»çº¿æ¨ç† |
| **å¤§æ¨¡å‹** | Qwen2.5-14B-Instruct | 14B Q4_K_M | ä¸­æ–‡å¼ºã€æŒ‡ä»¤éµå¾ªå¥½ |
| **Embedding** | BAAI/bge-m3 | - | å¤šåŠŸèƒ½æ£€ç´¢ã€ä¸­æ–‡ä¼˜ |
| **Reranker** | BAAI/bge-reranker-large | - | Cross-Encoder é‡æ’ |
| **å‘é‡åº“** | Qdrant | 1.11+ | å•æœºæ˜“ç”¨ã€åç»­å¯é›†ç¾¤ |
| **ç¨€ç–æ£€ç´¢** | OpenSearch | 2.13+ | BM25 + å…¨æ–‡æ£€ç´¢ |
| **å…³ç³»æ•°æ®åº“** | PostgreSQL | 15+ | ä¸šåŠ¡æ•°æ® + pgvectorï¼ˆå¯é€‰ï¼‰ |
| **ä¸šåŠ¡æ•°æ®åº“** | MySQL | 8.0+ | ä¼ä¸šåŸæœ‰æ•°æ®æº |
| **ç¼“å­˜** | Redis | 7+ | Sessionã€æ£€ç´¢ç¼“å­˜ |
| **ä»»åŠ¡é˜Ÿåˆ—** | Celery + Redis | - | å¼‚æ­¥ä»»åŠ¡ï¼ˆæ–‡æ¡£å…¥åº“ï¼‰ |
| **æ—¥å¿—** | Python logging + Loguru | - | ç»“æ„åŒ–æ—¥å¿— |
| **ç›‘æ§** | Prometheus + Grafana | - | æŒ‡æ ‡é‡‡é›†ä¸å¯è§†åŒ– |
| **é“¾è·¯è¿½è¸ª** | OpenTelemetry | - | RAG æµç¨‹è¿½è¸ª |

---

### 3.2 RAG æŠ€æœ¯é€‰å‹è¯¦è§£

#### 3.2.1 æ–¹æ¡ˆå¯¹æ¯”ï¼ˆA åŸºçº¿ vs A+å¢å¼ºï¼‰

| ç»´åº¦ | A åŸºçº¿ï¼ˆHybrid+å¼ºé‡æ’ï¼‰ | A+æŒ‰éœ€å¢å¼ºï¼ˆç°åº¦è§¦å‘ Multi-Query/HyDEï¼‰ |
|------|-------------------------|------------------------------------------|
| **RAG æ¡†æ¶** | Haystack 2 | åŒ A |
| **æ£€ç´¢ç­–ç•¥** | BM25 + å‘é‡æ£€ç´¢ + RRF + é‡æ’ | A + ç–‘éš¾é—®é¢˜è§¦å‘ Multi-Query/HyDE |
| **Recall@10** | 0.80-0.88 | 0.82-0.89ï¼ˆè§¦å‘åœºæ™¯æå‡æ˜æ˜¾ï¼‰ |
| **å“åº”å»¶è¿Ÿï¼ˆP50ï¼‰** | 1.2-1.8s | 1.3-2.2sï¼ˆè§¦å‘æ¯”ä¾‹ 10-30%ï¼‰ |
| **å·¥ç¨‹å¤æ‚åº¦** | ä½ | ä¸­ï¼ˆå¢åŠ ç°åº¦é€»è¾‘ä¸ç¼“å­˜ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å¿«ä¸Šçº¿ã€ç¨³äº§å‡º | ä»¥ A ä¸ºä¸»ï¼Œç–‘éš¾ææ•ˆ |

**æœ€ç»ˆé€‰å‹**ï¼š**A åŸºçº¿ + æŒ‰éœ€è§¦å‘ Multi-Query/HyDE**

**è§¦å‘æ¡ä»¶**ï¼ˆå¯é…ç½®å¼€å…³ï¼‰ï¼š
1. æ£€ç´¢ç½®ä¿¡åº¦ä½ï¼ˆTop-1 score < 0.6ï¼‰
2. å¬å›æ•°é‡ä¸è¶³ï¼ˆ< 3 æ¡ï¼‰
3. ç‰¹å®šé¢†åŸŸæ„å›¾ï¼ˆå¦‚"æ”¿ç­–è§£è¯»""æŠ€æœ¯ç»†èŠ‚"ï¼‰
4. ç”¨æˆ·åé¦ˆä½åˆ†åé‡è¯•

---

#### 3.2.2 æ ¸å¿ƒç»„ä»¶é…ç½®

**å¤§æ¨¡å‹ï¼ˆOllamaï¼‰**ï¼š
```yaml
model: qwen2.5:14b-instruct
quantization: Q4_K_M
temperature: 0.7
max_tokens: 512
top_p: 0.9
```

**Embeddingï¼ˆbge-m3ï¼‰**ï¼š
```python
from sentence_transformers import SentenceTransformer
model = SentenceTransformer("BAAI/bge-m3", device="cpu")
```

**Rerankerï¼ˆbge-reranker-largeï¼‰**ï¼š
```python
from sentence_transformers import CrossEncoder
reranker = CrossEncoder("BAAI/bge-reranker-large", device="cpu", max_length=512)
```

**å‘é‡åº“ï¼ˆQdrantï¼‰**ï¼š
```yaml
collection_name: knowledge_base
vector_size: 1024
```

**ç¨€ç–æ£€ç´¢ï¼ˆOpenSearchï¼‰**ï¼š
```json
{
  "index": "knowledge_base"
}
```

---

### 3.3 æ–‡æ¡£å¤„ç†æŠ€æœ¯æ ˆ

| æ ¼å¼ | è§£æåº“ | è¯´æ˜ |
|------|--------|------|
| **PDF** | PyPDF2 / pdfplumber | æ–‡æœ¬æå– |
| **DOCX** | python-docx | Word æ–‡æ¡£ |
| **PPTX** | python-pptx | PowerPoint |
| **MD** | markdown / mistune | Markdown |
| **TXT** | å†…ç½® | çº¯æ–‡æœ¬ |
| **CSV/XLSX** | pandas | è¡¨æ ¼æ•°æ® |
| **OCRï¼ˆå¯é€‰ï¼‰** | pytesseract / PaddleOCR | æ‰«æä»¶è¯†åˆ« |
| **æ¸…æ´—** | re + è‡ªå®šä¹‰è§„åˆ™ | å»é¡µçœ‰é¡µè„šã€æ°´å° |

**åˆ†å—ç­–ç•¥**ï¼š
```python
from haystack.components.preprocessors import DocumentSplitter
splitter = DocumentSplitter(
    split_by="token",
    split_length=400,
    split_overlap=80,
    tokenizer_model="gpt2"
)
```

---

## 4. RAG æŠ€æœ¯æ¶æ„

### 4.1 æ•´ä½“æµç¨‹å›¾

```
ç”¨æˆ·æ¶ˆæ¯
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. é¢„å¤„ç†                                          â”‚
â”‚     - æ„å›¾è¯†åˆ«                                      â”‚
â”‚     - å®ä½“æå–                                      â”‚
â”‚     - æŸ¥è¯¢å½’ä¸€åŒ–                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. è§¦å‘åˆ¤æ–­ï¼ˆç°åº¦é€»è¾‘ï¼‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”œâ”€ å¦ â”€â”€â–º å•æŸ¥è¯¢ â”€â”€â”
   â”‚                  â”‚
   â””â”€ æ˜¯ â”€â”€â–º Multi-Query/HyDE â”€â”€â–º å¤šæŸ¥è¯¢ â”€â”€â”
                                            â”‚
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Hybrid æ£€ç´¢                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. é‡æ’ï¼ˆCross-Encoderï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Prompt æ„å»º                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. LLM ç”Ÿæˆï¼ˆOllamaï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. åå¤„ç†                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. æŒä¹…åŒ–                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â–¼
è¿”å›å‰ç«¯
```

---

### 4.2 Multi-Query/HyDE å¢å¼ºç­–ç•¥

#### 4.2.1 Multi-Query

```python
async def multi_query_generate(original_query: str) -> List[str]:
    prompt = f"""å°†ä¸‹é¢çš„é—®é¢˜æ”¹å†™ä¸º3ä¸ªè¯­ä¹‰ç­‰ä»·çš„é—®é¢˜ï¼š\n\n{original_query}"""
    response = await ollama_generate(prompt, temperature=0.8)
    queries = parse_numbered_list(response)
    return [original_query] + queries
```

#### 4.2.2 HyDE

```python
async def hyde_generate(query: str) -> str:
    prompt = f"""ä¸ºä»¥ä¸‹é—®é¢˜å†™ä¸€æ®µ100å­—å·¦å³çš„å‚è€ƒç­”æ¡ˆï¼š\n{query}"""
    hypothetical_doc = await ollama_generate(prompt, max_tokens=200, temperature=0.7)
    return hypothetical_doc
```

#### 4.2.3 ç¼“å­˜

```python
@lru_cache(maxsize=1000)
def get_multi_queries_cached(query: str) -> List[str]:
    cache_key = f"multi_query:{hashlib.md5(query.encode()).hexdigest()}"
    cached = redis.get(cache_key)
    if cached:
        return json.loads(cached)
    queries = await multi_query_generate(query)
    redis.setex(cache_key, 3600, json.dumps(queries))
    return queries
```

---

### 4.3 Prompt å·¥ç¨‹

```python
SYSTEM_PROMPT = """ä½ æ˜¯{company_name}çš„æ™ºèƒ½å®¢æœåŠ©æ‰‹ã€‚\n\nå‚è€ƒèµ„æ–™ï¼š\n{context_with_citations}\n\nç”¨æˆ·é—®é¢˜ï¼š{user_question}\n\nè¯·åŸºäºå‚è€ƒèµ„æ–™å›ç­”ï¼Œå¹¶æ ‡æ³¨å¼•ç”¨ã€‚"""
```

```python
def format_context_with_citations(chunks: List[Document]) -> str:
    formatted = []
    for i, chunk in enumerate(chunks, start=1):
        source = chunk.meta.get("source", "æœªçŸ¥æ¥æº")
        content = chunk.content[:500]
        formatted.append(f"[{i}] æ¥æºï¼š{source}\nå†…å®¹ï¼š{content}\n")
    return "\n".join(formatted)
```

---

## 5. å¼€å‘è·¯çº¿è§„åˆ’

### 5.1 æ€»ä½“è®¡åˆ’

```
Week 1: åŸºç¡€æ¶æ„ + è®¤è¯æ¨¡å—
Week 2-3: RAG æ ¸å¿ƒæµç¨‹ + çŸ¥è¯†åº“ç®¡ç†
Week 4: MySQL é…ç½® + æ•°æ®æƒé™
Week 5: ç”¨æˆ·ç®¡ç† + æ™ºèƒ½é…ç½®
Week 6: æ•°æ®ç»Ÿè®¡ + ç³»ç»Ÿé…ç½®
Week 7: è”è°ƒæµ‹è¯• + ä¼˜åŒ–éƒ¨ç½²
```

### 5.2 è¯¦ç»†æ‹†è§£

#### Week 1
- é¡¹ç›®åˆå§‹åŒ–ã€Docker ç¯å¢ƒã€Alembic
- JWT è®¤è¯ã€ç™»å½•/ç™»å‡ºã€ä¸­é—´ä»¶
- é€šç”¨ CRUDã€é”™è¯¯å¤„ç†

#### Week 2-3
- Haystack ç®¡çº¿ã€Qdrant/OpenSearch é›†æˆ
- æ–‡æ¡£è§£æã€æ¸…æ´—ã€åˆ†å—ã€Embedding å†™å…¥
- Hybrid æ£€ç´¢ã€RRFã€é‡æ’ã€LLM ç”Ÿæˆ
- å¼•ç”¨æ ‡æ³¨ã€æ‹’ç­”é€»è¾‘
- Multi-Query/HyDE ç°åº¦ã€ç¼“å­˜æœºåˆ¶
- çŸ¥è¯†åº“ CRUDã€å¯¼å…¥å¯¼å‡ºã€é‡å»ºç´¢å¼•

#### Week 4
- SQL æ¨¡æ¿ç®¡ç†ã€å‚æ•°æ ¡éªŒã€æ‰§è¡Œæ—¥å¿—
- éƒ¨é—¨æ ‘ã€æƒé™ç»‘å®šã€å®¡è®¡æ—¥å¿—
- è·¨éƒ¨é—¨è®¿é—®æ ¡éªŒã€SQL æ³¨å…¥æµ‹è¯•

#### Week 5
- ç”¨æˆ·ç®¡ç†ã€è§’è‰²æƒé™ã€å¯†ç é‡ç½®ã€æ“ä½œæ—¥å¿—
- æ„å›¾ç®¡ç†ã€åŒä¹‰è¯é…ç½®ã€è§„åˆ™æµ‹è¯•

#### Week 6
- æ•°æ®çœ‹æ¿ã€æœªè¯†åˆ«é—®é¢˜ã€å¤±è´¥è®°å½•ã€éƒ¨é—¨ç»Ÿè®¡
- æŠ¥è¡¨å¯¼å‡ºã€ç³»ç»Ÿé…ç½®ã€ç¬¬ä¸‰æ–¹æ¥å£æµ‹è¯•ã€ç³»ç»Ÿæ—¥å¿—

#### Week 7
- å‰åç«¯è”è°ƒã€Bug ä¿®å¤ã€Swagger æ–‡æ¡£
- æ€§èƒ½è°ƒä¼˜ã€å‹æµ‹ã€ç¼“å­˜ç­–ç•¥
- Dockerfileã€docker-composeã€éƒ¨ç½²æ–‡æ¡£
- ä¸Šçº¿åŸ¹è®­ä¸äº¤ä»˜

### 5.3 ä¼˜å…ˆçº§

- **P0**ï¼šè®¤è¯ã€RAG åŸºçº¿ã€çŸ¥è¯†åº“ç®¡ç†
- **P1**ï¼šMySQL é…ç½®ã€æƒé™ã€ç”¨æˆ·ç®¡ç†
- **P2**ï¼šæ™ºèƒ½é…ç½®ã€æ•°æ®ç»Ÿè®¡ã€ç³»ç»Ÿé…ç½®ã€å¢å¼ºç­–ç•¥
- **P3**ï¼šæµå¼è¾“å‡ºã€ä¸Šä¸‹æ–‡è®°å¿†ã€A/B æµ‹è¯•

---

## 6. æ•°æ®åº“è®¾è®¡

### 6.1 æ ¸å¿ƒè¡¨

#### ç”¨æˆ·ä¸æƒé™

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    full_name VARCHAR(100),
    department_id INT REFERENCES departments(id),
    role_id INT REFERENCES roles(id),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    permissions JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id INT REFERENCES departments(id),
    level INT,
    path VARCHAR(500),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE login_logs (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id),
    ip_address VARCHAR(45),
    user_agent TEXT,
    status VARCHAR(20),
    message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### çŸ¥è¯†åº“

```sql
CREATE TABLE knowledge_base (
    id SERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    content TEXT,
    category VARCHAR(100),
    tags JSONB,
    source_file VARCHAR(500),
    source_type VARCHAR(50),
    status VARCHAR(20) DEFAULT 'active',
    department_id INT REFERENCES departments(id),
    created_by INT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version INT DEFAULT 1
);

CREATE TABLE knowledge_chunks (
    id SERIAL PRIMARY KEY,
    knowledge_id INT REFERENCES knowledge_base(id),
    chunk_index INT,
    content TEXT,
    embedding_id VARCHAR(100),
    opensearch_id VARCHAR(100),
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE knowledge_versions (
    id SERIAL PRIMARY KEY,
    knowledge_id INT REFERENCES knowledge_base(id),
    version INT,
    title VARCHAR(500),
    content TEXT,
    changed_by INT REFERENCES users(id),
    change_description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### å¯¹è¯ä¸åé¦ˆ

```sql
CREATE TABLE conversations (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id),
    title VARCHAR(500),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    conversation_id INT REFERENCES conversations(id),
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    sources JSONB,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE feedback (
    id SERIAL PRIMARY KEY,
    message_id INT REFERENCES messages(id),
    user_id INT REFERENCES users(id),
    feedback_type VARCHAR(20),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE retrieval_logs (
    id SERIAL PRIMARY KEY,
    message_id INT REFERENCES messages(id),
    query TEXT,
    query_rewritten TEXT,
    retrieval_strategy VARCHAR(50),
    bm25_results JSONB,
    vector_results JSONB,
    reranked_results JSONB,
    retrieval_time_ms INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### MySQL é…ç½®ä¸æ‰§è¡Œ

```sql
CREATE TABLE sql_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    sql_template TEXT NOT NULL,
    parameters JSONB,
    category VARCHAR(100),
    status VARCHAR(20) DEFAULT 'active',
    created_by INT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE sql_department_bindings (
    id SERIAL PRIMARY KEY,
    sql_id INT REFERENCES sql_templates(id),
    department_id INT REFERENCES departments(id),
    row_filter_condition TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE sql_execution_logs (
    id SERIAL PRIMARY KEY,
    sql_id INT REFERENCES sql_templates(id),
    user_id INT REFERENCES users(id),
    parameters JSONB,
    executed_sql TEXT,
    result_rows INT,
    execution_time_ms INT,
    status VARCHAR(20),
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### æ™ºèƒ½é…ç½®

```sql
CREATE TABLE intents (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    keywords JSONB,
    priority INT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE synonyms (
    id SERIAL PRIMARY KEY,
    word VARCHAR(100) NOT NULL,
    synonyms JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE qa_rules (
    id SERIAL PRIMARY KEY,
    rule_type VARCHAR(50),
    pattern TEXT,
    response TEXT,
    priority INT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ç³»ç»Ÿé…ç½®

```sql
CREATE TABLE system_config (
    id SERIAL PRIMARY KEY,
    key VARCHAR(200) UNIQUE NOT NULL,
    value TEXT,
    description TEXT,
    value_type VARCHAR(50),
    updated_by INT REFERENCES users(id),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE system_logs (
    id SERIAL PRIMARY KEY,
    level VARCHAR(20),
    module VARCHAR(100),
    message TEXT,
    stack_trace TEXT,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 6.2 ç´¢å¼•ä¼˜åŒ–

```sql
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_department ON users(department_id);
CREATE INDEX idx_kb_status ON knowledge_base(status);
CREATE INDEX idx_messages_conversation ON messages(conversation_id);
CREATE INDEX idx_sql_logs_created_at ON sql_execution_logs(created_at);
```

---

## 7. éƒ¨ç½²æ¶æ„

### 7.1 å•æœºæ‹“æ‰‘

```
Nginx â†’ FastAPI â†’ PostgreSQL / Redis / Qdrant / OpenSearch / Ollama
                           â†˜ Celery Worker
```

**ç¡¬ä»¶å»ºè®®**ï¼š
- CPU â‰¥ 8 æ ¸
- å†…å­˜ â‰¥ 32GB
- å­˜å‚¨ â‰¥ 200GB SSD
- å¯é€‰ GPUï¼ˆEmbedding/Reranker åŠ é€Ÿï¼‰

### 7.2 Docker Compose

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
  redis:
    image: redis:7-alpine
  qdrant:
    image: qdrant/qdrant:v1.11.0
  opensearch:
    image: opensearchproject/opensearch:2.13.0
  ollama:
    image: ollama/ollama:latest
  api:
    build: ./backend
  celery:
    build: ./backend
  nginx:
    image: nginx:alpine
```

### 7.3 éƒ¨ç½²æ­¥éª¤

```bash
# å®‰è£… Docker
curl -fsSL https://get.docker.com | bash

# å…‹éš†é¡¹ç›®
git clone <repository-url>

# æ‹·è´ç¯å¢ƒå˜é‡
cp .env.example .env

# å¯åŠ¨
docker-compose up -d

# ä¸‹è½½æ¨¡å‹
docker-compose exec ollama ollama pull qwen2.5:14b-instruct
```

### 7.4 æ‰©å±•æ¶æ„

- FastAPI å¤šå®ä¾‹ + Nginx è´Ÿè½½
- PostgreSQL ä¸»ä»å¤åˆ¶
- Redis Sentinel / Cluster
- Qdrant/Milvus é›†ç¾¤
- Ollama å¤šå®ä¾‹è½®è¯¢

---

## 8. å®‰å…¨ä¸æ€§èƒ½

### 8.1 å®‰å…¨

- JWT è®¤è¯ï¼ŒToken 2 å°æ—¶æœ‰æ•ˆ
- bcrypt å¯†ç åŠ å¯†ï¼ˆcost=12ï¼‰
- SQL æ¨¡æ¿ç™½åå• + å‚æ•°åŒ–
- åªè¯»æ•°æ®åº“è´¦å·
- éƒ¨é—¨çº§æ•°æ®éš”ç¦»ï¼Œè·¨éƒ¨é—¨å®¡è®¡
- æ•æ„Ÿå­—æ®µè„±æ•ï¼ˆæ‰‹æœºå·ã€èº«ä»½è¯ï¼‰
- CORS ç™½åå•ã€HTTPS å¼ºåˆ¶
- é™æµï¼ˆper-user/per-IPï¼‰
- æ–‡ä»¶ä¸Šä¼ ç±»å‹ä¸å¤§å°é™åˆ¶

### 8.2 æ€§èƒ½ä¼˜åŒ–

- å‘é‡æ£€ç´¢ HNSW å‚æ•°è°ƒä¼˜ï¼ˆef=128ï¼‰
- Redis ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢ã€Multi-Query ç»“æœ
- é‡æ’å™¨æ‰¹å¤„ç†ï¼ˆbatch size 32ï¼‰
- LLM é‡åŒ–ï¼ˆQ4_K_Mï¼‰
- Embedding/é‡æ’ INT8/ONNXï¼ˆå¯é€‰ï¼‰
- Celery å¼‚æ­¥å¤„ç†æ–‡æ¡£å…¥åº“
- æ ¹æ®åé¦ˆä¼˜åŒ–åˆ†å—å¤§å°

### 8.3 æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| API P95 å»¶è¿Ÿ | < 3s |
| æ£€ç´¢ P95 | < 500ms |
| LLM P95 | < 2s |
| å¹¶å‘ | 10-20 QPS |
| Recall@10 | > 0.80 |
| nDCG@10 | > 0.75 |

---

## 9. ç›‘æ§ä¸è¿ç»´

### 9.1 ç›‘æ§

- Prometheus + Grafanaï¼ˆQPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ã€èµ„æºï¼‰
- OpenTelemetry + Jaegerï¼ˆé“¾è·¯è¿½è¸ªï¼‰
- Flower ç›‘æ§ Celery é˜Ÿåˆ—
- å¥åº·æ£€æŸ¥ `/health`ã€`/readiness`

```python
from prometheus_fastapi_instrumentator import Instrumentator
Instrumentator().instrument(app).expose(app)
```

### 9.2 å‘Šè­¦

| é¡¹ç›® | é˜ˆå€¼ | é€šçŸ¥ |
|------|------|------|
| API é”™è¯¯ç‡ | >5% | ä¼ä¸šå¾®ä¿¡/é’‰é’‰ |
| API P95 | >5s | ä¼ä¸šå¾®ä¿¡ |
| DB è¿æ¥å ç”¨ | >80% | ä¼ä¸šå¾®ä¿¡ |
| Celery é˜Ÿåˆ— | >1000 | é’‰é’‰ |
| ç£ç›˜å ç”¨ | >85% | ä¼ä¸šå¾®ä¿¡ |

### 9.3 è¿ç»´è„šæœ¬

```bash
#!/bin/bash
# æ•°æ®åº“å¤‡ä»½
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
docker-compose exec -T postgres pg_dump -U ai_user ai_support_system | gzip > backups/db_$TIMESTAMP.sql.gz
```

```bash
#!/bin/bash
# Qdrant å¤‡ä»½
docker-compose exec qdrant tar -czf /tmp/qdrant_backup.tar.gz /qdrant/storage
```

### 9.4 æ•…éšœæ¢å¤

- `docker-compose restart <service>`
- æ•°æ®æ¢å¤ï¼šè¿˜åŸ PostgreSQL dumpã€Qdrant å¤‡ä»½
- Ollama æ¨¡å‹é‡æ–°åŠ è½½

---

## 10. é™„å½•

### 10.1 ä¾èµ–

```txt
fastapi
uvicorn[standard]
pydantic
sqlalchemy
alembic
asyncpg
redis
haystack-ai
sentence-transformers
qdrant-client
opensearch-py
pypdf2
python-docx
python-pptx
pandas
celery
bcrypt
python-jose[cryptography]
loguru
```

### 10.2 ç¯å¢ƒå˜é‡

```bash
APP_ENV=development
API_PORT=8080
DATABASE_URL=postgresql://ai_user:password@postgres:5432/ai_support_system
REDIS_URL=redis://redis:6379/0
QDRANT_URL=http://qdrant:6333
OPENSEARCH_URL=http://opensearch:9200
OLLAMA_URL=http://ollama:11434
OLLAMA_MODEL=qwen2.5:14b-instruct
JWT_SECRET_KEY=change_me
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=120
ENABLE_MULTI_QUERY=true
ENABLE_HYDE=true
```

### 10.3 æ ¸å¿ƒæ¥å£ç¤ºä¾‹

```http
POST /api/chat/message
Authorization: Bearer <token>
Content-Type: application/json

{
  "conversation_id": "123",
  "message": "å…¬å¸å¹´å‡æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ"
}
```

```json
{
  "answer": "æ ¹æ®å…¬å¸è§„å®š... [1]",
  "sources": [
    {
      "id": "kb_123",
      "title": "å‘˜å·¥æ‰‹å†Œ v2",
      "snippet": "å¹´å‡å¤©æ•°...",
      "score": 0.85
    }
  ],
  "metadata": {
    "retrieval_time_ms": 230,
    "llm_time_ms": 1450,
    "strategy": "hybrid"
  }
}
```

### 10.4 ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ main.py
â”œâ”€â”€ config.py
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ .env.example
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ schemas/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ utils/
â”œâ”€â”€ celery_app/
â”œâ”€â”€ scripts/
â”œâ”€â”€ tests/
â””â”€â”€ logs/
```

---

<div align="center">

**ğŸ“§ æŠ€æœ¯æ”¯æŒ**: dev-team@your-company.com  
**ğŸ“ ç‰ˆæœ¬**: v1.0.0 Â· æ›´æ–°æ—¶é—´ 2025-01-XX

</div>

