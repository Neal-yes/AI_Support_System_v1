# 企业智能客服系统 - 后端开发技术方案

<div align="center">

![Python](https://img.shields.io/badge/Python-3.10+-3776ab.svg?logo=python)
![FastAPI](https://img.shields.io/badge/FastAPI-0.115+-009688.svg?logo=fastapi)
![Haystack](https://img.shields.io/badge/Haystack-2.x-FF6B6B.svg)
![Ollama](https://img.shields.io/badge/Ollama-Latest-000000.svg)
![PostgreSQL](https://img.shields.io/badge/PostgreSQL-15+-336791.svg?logo=postgresql)

**基于 Haystack 2 + Ollama + Hybrid 检索 + 强重排的企业级 RAG 方案**

</div>

---

## 📋 目录

- [1. 项目概述](#1-项目概述)
- [2. 功能模块详细梳理](#2-功能模块详细梳理)
- [3. 核心技术选型](#3-核心技术选型)
- [4. RAG 技术架构](#4-rag-技术架构)
- [5. 开发路线规划](#5-开发路线规划)
- [6. 数据库设计](#6-数据库设计)
- [7. 部署架构](#7-部署架构)
- [8. 安全与性能](#8-安全与性能)
- [9. 监控与运维](#9-监控与运维)
- [10. 附录](#10-附录)

---

## 1. 项目概述

### 1.1 项目定位

企业智能客服系统后端是一个**轻量级、私有化部署**的 AI 问答服务，面向企业内部用户提供：
- 基于知识库的智能问答（RAG）
- 结构化数据查询（MySQL 中间层）
- 部门级数据权限隔离
- 管理后台支撑功能

### 1.2 核心特性

- ✅ **本地私有部署**：全开源技术栈，无外部依赖
- ✅ **稳健 RAG 基线**：Hybrid 检索 + Cross-Encoder 重排
- ✅ **按需增强召回**：疑难问题触发 Multi-Query/HyDE
- ✅ **数据安全**：部门级隔离 + SQL 注入防护 + 审计日志
- ✅ **可观测性**：完整的链路追踪与性能指标
- ✅ **易扩展**：模块化设计，后期可平滑迁移扩容

### 1.3 技术约束

- **部署环境**：本地服务器（初期单机，后期可分布式）
- **模型运行**：离线推理（Ollama）
- **响应要求**：P95 延迟 < 3s（含生成）
- **并发能力**：初期 10-20 QPS，预留扩展空间
- **存储容量**：知识库初期 < 10GB，预留 100GB

---

## 2. 功能模块详细梳理

### 2.1 模块总览

| 模块 | 优先级 | 复杂度 | 开发周期 | 依赖关系 |
|------|--------|--------|----------|----------|
| **认证鉴权** | P0 | 低 | 2天 | 无 |
| **智能对话（RAG）** | P0 | 高 | 10天 | 认证、知识库 |
| **知识库管理** | P0 | 中 | 5天 | 认证 |
| **MySQL 配置与查询** | P1 | 中 | 4天 | 认证、权限 |
| **数据权限管理** | P1 | 中 | 3天 | 认证 |
| **用户与角色管理** | P1 | 低 | 2天 | 认证 |
| **智能配置（意图/同义词）** | P2 | 中 | 3天 | 认证 |
| **数据统计分析** | P2 | 低 | 3天 | 认证 |
| **系统配置** | P2 | 低 | 2天 | 认证 |

> **开发总计**：约 34 人天（约 7 周，1 人全职）

---

### 2.2 模块详细说明

#### 2.2.1 认证鉴权模块（P0，2天）

**功能范围**：
- 用户登录（账号密码）
- JWT Token 签发与验证
- Token 刷新机制
- 登出（Token 失效）
- 中间件：路由鉴权

**接口清单**：
```
POST   /api/auth/login        # 登录
POST   /api/auth/logout       # 登出
GET    /api/auth/verify       # 验证 Token
POST   /api/auth/refresh      # 刷新 Token
```

**核心逻辑**：
- 密码使用 bcrypt 加密存储
- JWT Payload 包含：user_id、username、role、exp
- Token 有效期：2 小时（可配置）
- Refresh Token 有效期：7 天

**数据表**：
- `users`（用户表）
- `login_logs`（登录日志）

---

#### 2.2.2 智能对话模块（P0，10天）

**功能范围**：
- 接收用户消息，调用 RAG 流程
- Hybrid 检索（BM25 + 向量）
- Cross-Encoder 重排
- 疑难问题触发 Multi-Query/HyDE（灰度）
- LLM 生成回答（携带引用）
- 对话历史管理
- 会话上下文管理

**接口清单**：
```
POST   /api/chat/message            # 发送消息
GET    /api/chat/conversations      # 获取对话列表
GET    /api/chat/conversation/:id   # 获取对话详情
DELETE /api/chat/conversation/:id   # 删除对话
POST   /api/chat/feedback           # 用户反馈（点赞/点踩）
```

**核心 RAG 流程**（详见 4.RAG 技术架构）：
1. 用户输入预处理（意图识别、实体提取）
2. 判断是否触发 Multi-Query/HyDE（低置信度/特定意图）
3. Hybrid 检索（BM25 + 向量，各 Top-20）
4. RRF 融合 + Cross-Encoder 重排（Top-8）
5. 构建 Prompt（携带引用片段）
6. LLM 生成回答
7. 后处理（引用标注、敏感词过滤）
8. 保存对话记录与反馈

**数据表**：
- `conversations`（对话会话）
- `messages`（消息记录）
- `feedback`（用户反馈）
- `retrieval_logs`（检索日志，用于优化）

---

#### 2.2.3 知识库管理模块（P0，5天）

**功能范围**：
- 知识条目 CRUD
- 多格式文档上传（PDF、DOCX、PPTX、MD、TXT、CSV、XLSX）
- 文档解析与清洗
- 分块（Chunking）
- 向量化（Embedding）
- 写入向量库（Qdrant）+ BM25 索引（OpenSearch）
- 批量导出
- 版本管理

**接口清单**：
```
GET    /api/knowledge/list           # 获取知识列表（分页、筛选）
POST   /api/knowledge/add            # 新增知识
GET    /api/knowledge/:id            # 获取知识详情
PUT    /api/knowledge/:id            # 更新知识
DELETE /api/knowledge/:id            # 删除知识
POST   /api/knowledge/import         # 批量导入文档
GET    /api/knowledge/export         # 批量导出
GET    /api/knowledge/preview/:id    # 预览知识
POST   /api/knowledge/reindex        # 重建索引
```

**文档处理流程**：
```
上传文件 → 格式识别 → 文本提取（Unstructured/PyPDF2/python-docx）
  → 清洗（去页眉页脚/水印/目录） → 分块（350-500 tokens, overlap 50-100）
  → Embedding（bge-m3） → 写入 Qdrant + OpenSearch → 元数据入库（PostgreSQL）
```

**数据表**：
- `knowledge_base`（知识条目元数据）
- `knowledge_chunks`（分块记录，用于溯源）
- `knowledge_versions`（版本历史）

---

#### 2.2.4 MySQL 配置与查询模块（P1，4天）

**功能范围**：
- SQL 语句模板管理（参数化，`{{变量}}` 语法）
- 参数校验与类型转换
- 执行 SQL（只读账号，防注入）
- 结果脱敏（手机号、身份证）
- 与部门权限绑定（行级过滤）
- 执行日志记录

**接口清单**：
```
GET    /api/mysql/statements         # 获取 SQL 列表
POST   /api/mysql/statements         # 新增 SQL 模板
GET    /api/mysql/statements/:id     # 获取 SQL 详情
PUT    /api/mysql/statements/:id     # 更新 SQL 模板
DELETE /api/mysql/statements/:id     # 删除 SQL 模板
POST   /api/mysql/test               # 测试 SQL（需参数）
POST   /api/mysql/execute            # 执行 SQL（智能对话调用）
GET    /api/mysql/logs               # 查看执行日志
```

**安全机制**：
- SQL 白名单（只允许 SELECT）
- 参数类型严格校验（防注入）
- 只读账号连接（read-only user）
- 部门权限过滤（自动注入 WHERE 条件）
- 结果敏感数据脱敏（正则替换）

**数据表**：
- `sql_templates`（SQL 模板）
- `sql_execution_logs`（执行日志）
- `sql_department_bindings`（SQL 与部门绑定关系）

---

#### 2.2.5 数据权限管理模块（P1，3天）

**功能范围**：
- 部门信息维护（树形结构）
- SQL 语句与部门绑定
- 用户与部门关联
- 权限审计日志

**接口清单**：
```
GET    /api/permission/departments          # 获取部门列表（树形）
POST   /api/permission/departments          # 新增部门
PUT    /api/permission/departments/:id      # 更新部门
DELETE /api/permission/departments/:id      # 删除部门
GET    /api/permission/bindings             # 获取权限绑定列表
POST   /api/permission/bindings             # 绑定 SQL 到部门
GET    /api/permission/audit-logs           # 权限审计日志
```

**权限控制逻辑**：
- 用户登录后，Token 中携带 `department_id`
- 查询知识库时，仅返回该部门可见的知识
- 执行 SQL 时，自动注入部门过滤条件
- 跨部门访问尝试记录审计日志

**数据表**：
- `departments`（部门表）
- `user_department_bindings`（用户部门关联）
- `permission_audit_logs`（审计日志）

---

#### 2.2.6 用户与角色管理模块（P1，2天）

**功能范围**：
- 管理员账号 CRUD
- 角色定义（超级管理员、普通管理员、只读用户）
- 角色权限配置（模块级）
- 密码重置
- 操作日志

**接口清单**：
```
GET    /api/users/admins             # 获取管理员列表
POST   /api/users/admins             # 新增管理员
GET    /api/users/admins/:id         # 获取管理员详情
PUT    /api/users/admins/:id         # 更新管理员
DELETE /api/users/admins/:id         # 删除管理员
POST   /api/users/admins/:id/reset-password  # 重置密码
GET    /api/users/roles              # 获取角色列表
POST   /api/users/roles              # 新增角色
PUT    /api/users/roles/:id          # 更新角色
DELETE /api/users/roles/:id          # 删除角色
POST   /api/users/assign-role        # 分配角色
GET    /api/users/login-logs         # 获取登录日志
```

**角色权限矩阵**（示例）：
| 角色 | 知识库管理 | MySQL 配置 | 用户管理 | 数据统计 |
|------|------------|------------|----------|----------|
| **超级管理员** | ✅ | ✅ | ✅ | ✅ |
| **普通管理员** | ✅ | ✅ | ❌ | ✅ |
| **只读用户** | 查看 | 查看 | ❌ | 查看 |

**数据表**：
- `users`（用户表）
- `roles`（角色表）
- `role_permissions`（角色权限）
- `user_roles`（用户角色关联）

---

#### 2.2.7 智能配置模块（P2，3天）

**功能范围**：
- 意图标签管理
- 同义词/变体配置
- 问答规则（关键词、正则）
- 优先级与状态管理
- 规则测试

**接口清单**：
```
GET    /api/intelligent/intents          # 获取意图列表
POST   /api/intelligent/intents          # 新增意图
PUT    /api/intelligent/intents/:id      # 更新意图
DELETE /api/intelligent/intents/:id      # 删除意图
GET    /api/intelligent/rules            # 获取问答规则列表
POST   /api/intelligent/rules            # 新增问答规则
POST   /api/intelligent/test             # 测试意图识别
```

**数据表**：
- `intents`（意图表）
- `synonyms`（同义词）
- `qa_rules`（问答规则）

---

#### 2.2.8 数据统计分析模块（P2，3天）

**功能范围**：
- 核心指标看板（查询量、响应时间、解决率、准确率）
- 动态时间筛选（今日、本周、本月、自定义）
- 未识别问题 TOP10
- SQL 失败记录
- 部门查询统计
- 报表导出（CSV/Excel）

**接口清单**：
```
GET    /api/analytics/dashboard                # 数据看板
GET    /api/analytics/metrics                  # 核心指标
GET    /api/analytics/unrecognized-questions   # 未识别问题TOP10
GET    /api/analytics/sql-failures             # SQL 失败记录
GET    /api/analytics/department-stats         # 部门统计
POST   /api/analytics/export                   # 导出报表
```

**数据表**：
- 复用 `messages`、`feedback`、`sql_execution_logs` 等表
- 可选：`analytics_snapshots`（定时快照，加速查询）

---

#### 2.2.9 系统配置模块（P2，2天）

**功能范围**：
- 基础信息设置（企业名称、系统名称）
- 接口配置（企业微信、钉钉、OA）
- 通知规则配置
- 系统日志管理

**接口清单**：
```
GET    /api/system/config                # 获取系统配置
PUT    /api/system/config                # 更新系统配置
POST   /api/system/config/test-connection # 测试第三方接口
GET    /api/system/notifications         # 获取通知规则
POST   /api/system/notifications         # 新增通知规则
PUT    /api/system/notifications/:id     # 更新通知规则
DELETE /api/system/notifications/:id     # 删除通知规则
GET    /api/system/logs                  # 查看系统日志
GET    /api/health                       # 健康检查
GET    /api/metrics                      # Prometheus指标
```

**数据表**：
- `system_config`（系统配置，KV 结构）
- `system_logs`（系统日志）

---

## 3. 核心技术选型

### 3.1 总体技术栈

| 层级 | 技术选型 | 版本 | 说明 |
|------|----------|------|------|
| **编程语言** | Python | 3.10+ | RAG 生态成熟 |
| **Web 框架** | FastAPI | 0.115+ | 高性能异步框架 |
| **RAG 框架** | Haystack 2 | 2.1.0+ | 工业级管线、可观测性强 |
| **大模型推理** | Ollama | Latest | 本地离线推理 |
| **大模型** | Qwen2.5-14B-Instruct | 14B Q4_K_M | 中文强、指令遵循好 |
| **Embedding** | BAAI/bge-m3 | - | 多功能检索、中文优 |
| **Reranker** | BAAI/bge-reranker-large | - | Cross-Encoder 重排 |
| **向量库** | Qdrant | 1.11+ | 单机易用、后续可集群 |
| **稀疏检索** | OpenSearch | 2.13+ | BM25 + 全文检索 |
| **关系数据库** | PostgreSQL | 15+ | 业务数据 + pgvector（可选） |
| **业务数据库** | MySQL | 8.0+ | 企业原有数据源 |
| **缓存** | Redis | 7+ | Session、检索缓存 |
| **任务队列** | Celery + Redis | - | 异步任务（文档入库） |
| **日志** | Python logging + Loguru | - | 结构化日志 |
| **监控** | Prometheus + Grafana | - | 指标采集与可视化 |
| **链路追踪** | OpenTelemetry | - | RAG 流程追踪 |

---

### 3.2 RAG 技术选型详解

#### 3.2.1 方案对比（A 基线 vs A+增强）

| 维度 | A 基线（Hybrid+强重排） | A+按需增强（灰度触发 Multi-Query/HyDE） |
|------|-------------------------|------------------------------------------|
| **RAG 框架** | Haystack 2 | 同 A |
| **检索策略** | BM25 + 向量检索 + RRF + 重排 | A + 疑难问题触发 Multi-Query/HyDE |
| **Recall@10** | 0.80-0.88 | 0.82-0.89（触发场景提升明显） |
| **响应延迟（P50）** | 1.2-1.8s | 1.3-2.2s（触发比例 10-30%） |
| **工程复杂度** | 低 | 中（增加灰度逻辑与缓存） |
| **适用场景** | 快上线、稳产出 | 以 A 为主，疑难提效 |

**最终选型**：**A 基线 + 按需触发 Multi-Query/HyDE**

**触发条件**（可配置开关）：
1. 检索置信度低（Top-1 score < 0.6）
2. 召回数量不足（< 3 条）
3. 特定领域意图（如"政策解读""技术细节"）
4. 用户反馈低分后重试

---

#### 3.2.2 核心组件配置

**大模型（Ollama）**：
```yaml
model: qwen2.5:14b-instruct
quantization: Q4_K_M
temperature: 0.7
max_tokens: 512
top_p: 0.9
```

**Embedding（bge-m3）**：
```python
from sentence_transformers import SentenceTransformer
model = SentenceTransformer("BAAI/bge-m3", device="cpu")
```

**Reranker（bge-reranker-large）**：
```python
from sentence_transformers import CrossEncoder
reranker = CrossEncoder("BAAI/bge-reranker-large", device="cpu", max_length=512)
```

**向量库（Qdrant）**：
```yaml
collection_name: knowledge_base
vector_size: 1024
```

**稀疏检索（OpenSearch）**：
```json
{
  "index": "knowledge_base"
}
```

---

### 3.3 文档处理技术栈

| 格式 | 解析库 | 说明 |
|------|--------|------|
| **PDF** | PyPDF2 / pdfplumber | 文本提取 |
| **DOCX** | python-docx | Word 文档 |
| **PPTX** | python-pptx | PowerPoint |
| **MD** | markdown / mistune | Markdown |
| **TXT** | 内置 | 纯文本 |
| **CSV/XLSX** | pandas | 表格数据 |
| **OCR（可选）** | pytesseract / PaddleOCR | 扫描件识别 |
| **清洗** | re + 自定义规则 | 去页眉页脚、水印 |

**分块策略**：
```python
from haystack.components.preprocessors import DocumentSplitter
splitter = DocumentSplitter(
    split_by="token",
    split_length=400,
    split_overlap=80,
    tokenizer_model="gpt2"
)
```

---

## 4. RAG 技术架构

### 4.1 整体流程图

```
用户消息
   │
   ▼
┌─────────────────────────────────────────────────────┐
│  1. 预处理                                          │
│     - 意图识别                                      │
│     - 实体提取                                      │
│     - 查询归一化                                    │
└─────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────┐
│  2. 触发判断（灰度逻辑）                            │
└─────────────────────────────────────────────────────┘
   │
   ├─ 否 ──► 单查询 ──┐
   │                  │
   └─ 是 ──► Multi-Query/HyDE ──► 多查询 ──┐
                                            │
                                            ▼
┌─────────────────────────────────────────────────────┐
│  3. Hybrid 检索                                     │
└─────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────┐
│  4. 重排（Cross-Encoder）                           │
└─────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────┐
│  5. Prompt 构建                                     │
└─────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────┐
│  6. LLM 生成（Ollama）                              │
└─────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────┐
│  7. 后处理                                          │
└─────────────────────────────────────────────────────┘
   │
   ▼
┌─────────────────────────────────────────────────────┐
│  8. 持久化                                          │
└─────────────────────────────────────────────────────┘
   │
   ▼
返回前端
```

---

### 4.2 Multi-Query/HyDE 增强策略

#### 4.2.1 Multi-Query

```python
async def multi_query_generate(original_query: str) -> List[str]:
    prompt = f"""将下面的问题改写为3个语义等价的问题：\n\n{original_query}"""
    response = await ollama_generate(prompt, temperature=0.8)
    queries = parse_numbered_list(response)
    return [original_query] + queries
```

#### 4.2.2 HyDE

```python
async def hyde_generate(query: str) -> str:
    prompt = f"""为以下问题写一段100字左右的参考答案：\n{query}"""
    hypothetical_doc = await ollama_generate(prompt, max_tokens=200, temperature=0.7)
    return hypothetical_doc
```

#### 4.2.3 缓存

```python
@lru_cache(maxsize=1000)
def get_multi_queries_cached(query: str) -> List[str]:
    cache_key = f"multi_query:{hashlib.md5(query.encode()).hexdigest()}"
    cached = redis.get(cache_key)
    if cached:
        return json.loads(cached)
    queries = await multi_query_generate(query)
    redis.setex(cache_key, 3600, json.dumps(queries))
    return queries
```

---

### 4.3 Prompt 工程

```python
SYSTEM_PROMPT = """你是{company_name}的智能客服助手。\n\n参考资料：\n{context_with_citations}\n\n用户问题：{user_question}\n\n请基于参考资料回答，并标注引用。"""
```

```python
def format_context_with_citations(chunks: List[Document]) -> str:
    formatted = []
    for i, chunk in enumerate(chunks, start=1):
        source = chunk.meta.get("source", "未知来源")
        content = chunk.content[:500]
        formatted.append(f"[{i}] 来源：{source}\n内容：{content}\n")
    return "\n".join(formatted)
```

---

## 5. 开发路线规划

### 5.1 总体计划

```
Week 1: 基础架构 + 认证模块
Week 2-3: RAG 核心流程 + 知识库管理
Week 4: MySQL 配置 + 数据权限
Week 5: 用户管理 + 智能配置
Week 6: 数据统计 + 系统配置
Week 7: 联调测试 + 优化部署
```

### 5.2 详细拆解

#### Week 1
- 项目初始化、Docker 环境、Alembic
- JWT 认证、登录/登出、中间件
- 通用 CRUD、错误处理

#### Week 2-3
- Haystack 管线、Qdrant/OpenSearch 集成
- 文档解析、清洗、分块、Embedding 写入
- Hybrid 检索、RRF、重排、LLM 生成
- 引用标注、拒答逻辑
- Multi-Query/HyDE 灰度、缓存机制
- 知识库 CRUD、导入导出、重建索引

#### Week 4
- SQL 模板管理、参数校验、执行日志
- 部门树、权限绑定、审计日志
- 跨部门访问校验、SQL 注入测试

#### Week 5
- 用户管理、角色权限、密码重置、操作日志
- 意图管理、同义词配置、规则测试

#### Week 6
- 数据看板、未识别问题、失败记录、部门统计
- 报表导出、系统配置、第三方接口测试、系统日志

#### Week 7
- 前后端联调、Bug 修复、Swagger 文档
- 性能调优、压测、缓存策略
- Dockerfile、docker-compose、部署文档
- 上线培训与交付

### 5.3 优先级

- **P0**：认证、RAG 基线、知识库管理
- **P1**：MySQL 配置、权限、用户管理
- **P2**：智能配置、数据统计、系统配置、增强策略
- **P3**：流式输出、上下文记忆、A/B 测试

---

## 6. 数据库设计

### 6.1 核心表

#### 用户与权限

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    full_name VARCHAR(100),
    department_id INT REFERENCES departments(id),
    role_id INT REFERENCES roles(id),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description TEXT,
    permissions JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id INT REFERENCES departments(id),
    level INT,
    path VARCHAR(500),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE login_logs (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id),
    ip_address VARCHAR(45),
    user_agent TEXT,
    status VARCHAR(20),
    message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 知识库

```sql
CREATE TABLE knowledge_base (
    id SERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    content TEXT,
    category VARCHAR(100),
    tags JSONB,
    source_file VARCHAR(500),
    source_type VARCHAR(50),
    status VARCHAR(20) DEFAULT 'active',
    department_id INT REFERENCES departments(id),
    created_by INT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version INT DEFAULT 1
);

CREATE TABLE knowledge_chunks (
    id SERIAL PRIMARY KEY,
    knowledge_id INT REFERENCES knowledge_base(id),
    chunk_index INT,
    content TEXT,
    embedding_id VARCHAR(100),
    opensearch_id VARCHAR(100),
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE knowledge_versions (
    id SERIAL PRIMARY KEY,
    knowledge_id INT REFERENCES knowledge_base(id),
    version INT,
    title VARCHAR(500),
    content TEXT,
    changed_by INT REFERENCES users(id),
    change_description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 对话与反馈

```sql
CREATE TABLE conversations (
    id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(id),
    title VARCHAR(500),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    conversation_id INT REFERENCES conversations(id),
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    sources JSONB,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE feedback (
    id SERIAL PRIMARY KEY,
    message_id INT REFERENCES messages(id),
    user_id INT REFERENCES users(id),
    feedback_type VARCHAR(20),
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE retrieval_logs (
    id SERIAL PRIMARY KEY,
    message_id INT REFERENCES messages(id),
    query TEXT,
    query_rewritten TEXT,
    retrieval_strategy VARCHAR(50),
    bm25_results JSONB,
    vector_results JSONB,
    reranked_results JSONB,
    retrieval_time_ms INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### MySQL 配置与执行

```sql
CREATE TABLE sql_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    sql_template TEXT NOT NULL,
    parameters JSONB,
    category VARCHAR(100),
    status VARCHAR(20) DEFAULT 'active',
    created_by INT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE sql_department_bindings (
    id SERIAL PRIMARY KEY,
    sql_id INT REFERENCES sql_templates(id),
    department_id INT REFERENCES departments(id),
    row_filter_condition TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE sql_execution_logs (
    id SERIAL PRIMARY KEY,
    sql_id INT REFERENCES sql_templates(id),
    user_id INT REFERENCES users(id),
    parameters JSONB,
    executed_sql TEXT,
    result_rows INT,
    execution_time_ms INT,
    status VARCHAR(20),
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 智能配置

```sql
CREATE TABLE intents (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    keywords JSONB,
    priority INT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE synonyms (
    id SERIAL PRIMARY KEY,
    word VARCHAR(100) NOT NULL,
    synonyms JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE qa_rules (
    id SERIAL PRIMARY KEY,
    rule_type VARCHAR(50),
    pattern TEXT,
    response TEXT,
    priority INT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 系统配置

```sql
CREATE TABLE system_config (
    id SERIAL PRIMARY KEY,
    key VARCHAR(200) UNIQUE NOT NULL,
    value TEXT,
    description TEXT,
    value_type VARCHAR(50),
    updated_by INT REFERENCES users(id),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE system_logs (
    id SERIAL PRIMARY KEY,
    level VARCHAR(20),
    module VARCHAR(100),
    message TEXT,
    stack_trace TEXT,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 6.2 索引优化

```sql
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_department ON users(department_id);
CREATE INDEX idx_kb_status ON knowledge_base(status);
CREATE INDEX idx_messages_conversation ON messages(conversation_id);
CREATE INDEX idx_sql_logs_created_at ON sql_execution_logs(created_at);
```

---

## 7. 部署架构

### 7.1 单机拓扑

```
Nginx → FastAPI → PostgreSQL / Redis / Qdrant / OpenSearch / Ollama
                           ↘ Celery Worker
```

**硬件建议**：
- CPU ≥ 8 核
- 内存 ≥ 32GB
- 存储 ≥ 200GB SSD
- 可选 GPU（Embedding/Reranker 加速）

### 7.2 Docker Compose

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
  redis:
    image: redis:7-alpine
  qdrant:
    image: qdrant/qdrant:v1.11.0
  opensearch:
    image: opensearchproject/opensearch:2.13.0
  ollama:
    image: ollama/ollama:latest
  api:
    build: ./backend
  celery:
    build: ./backend
  nginx:
    image: nginx:alpine
```

### 7.3 部署步骤

```bash
# 安装 Docker
curl -fsSL https://get.docker.com | bash

# 克隆项目
git clone <repository-url>

# 拷贝环境变量
cp .env.example .env

# 启动
docker-compose up -d

# 下载模型
docker-compose exec ollama ollama pull qwen2.5:14b-instruct
```

### 7.4 扩展架构

- FastAPI 多实例 + Nginx 负载
- PostgreSQL 主从复制
- Redis Sentinel / Cluster
- Qdrant/Milvus 集群
- Ollama 多实例轮询

---

## 8. 安全与性能

### 8.1 安全

- JWT 认证，Token 2 小时有效
- bcrypt 密码加密（cost=12）
- SQL 模板白名单 + 参数化
- 只读数据库账号
- 部门级数据隔离，跨部门审计
- 敏感字段脱敏（手机号、身份证）
- CORS 白名单、HTTPS 强制
- 限流（per-user/per-IP）
- 文件上传类型与大小限制

### 8.2 性能优化

- 向量检索 HNSW 参数调优（ef=128）
- Redis 缓存热点查询、Multi-Query 结果
- 重排器批处理（batch size 32）
- LLM 量化（Q4_K_M）
- Embedding/重排 INT8/ONNX（可选）
- Celery 异步处理文档入库
- 根据反馈优化分块大小

### 8.3 指标

| 指标 | 目标 |
|------|------|
| API P95 延迟 | < 3s |
| 检索 P95 | < 500ms |
| LLM P95 | < 2s |
| 并发 | 10-20 QPS |
| Recall@10 | > 0.80 |
| nDCG@10 | > 0.75 |

---

## 9. 监控与运维

### 9.1 监控

- Prometheus + Grafana（QPS、延迟、错误率、资源）
- OpenTelemetry + Jaeger（链路追踪）
- Flower 监控 Celery 队列
- 健康检查 `/health`、`/readiness`

```python
from prometheus_fastapi_instrumentator import Instrumentator
Instrumentator().instrument(app).expose(app)
```

### 9.2 告警

| 项目 | 阈值 | 通知 |
|------|------|------|
| API 错误率 | >5% | 企业微信/钉钉 |
| API P95 | >5s | 企业微信 |
| DB 连接占用 | >80% | 企业微信 |
| Celery 队列 | >1000 | 钉钉 |
| 磁盘占用 | >85% | 企业微信 |

### 9.3 运维脚本

```bash
#!/bin/bash
# 数据库备份
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
docker-compose exec -T postgres pg_dump -U ai_user ai_support_system | gzip > backups/db_$TIMESTAMP.sql.gz
```

```bash
#!/bin/bash
# Qdrant 备份
docker-compose exec qdrant tar -czf /tmp/qdrant_backup.tar.gz /qdrant/storage
```

### 9.4 故障恢复

- `docker-compose restart <service>`
- 数据恢复：还原 PostgreSQL dump、Qdrant 备份
- Ollama 模型重新加载

---

## 10. 附录

### 10.1 依赖

```txt
fastapi
uvicorn[standard]
pydantic
sqlalchemy
alembic
asyncpg
redis
haystack-ai
sentence-transformers
qdrant-client
opensearch-py
pypdf2
python-docx
python-pptx
pandas
celery
bcrypt
python-jose[cryptography]
loguru
```

### 10.2 环境变量

```bash
APP_ENV=development
API_PORT=8080
DATABASE_URL=postgresql://ai_user:password@postgres:5432/ai_support_system
REDIS_URL=redis://redis:6379/0
QDRANT_URL=http://qdrant:6333
OPENSEARCH_URL=http://opensearch:9200
OLLAMA_URL=http://ollama:11434
OLLAMA_MODEL=qwen2.5:14b-instruct
JWT_SECRET_KEY=change_me
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=120
ENABLE_MULTI_QUERY=true
ENABLE_HYDE=true
```

### 10.3 核心接口示例

```http
POST /api/chat/message
Authorization: Bearer <token>
Content-Type: application/json

{
  "conversation_id": "123",
  "message": "公司年假政策是什么？"
}
```

```json
{
  "answer": "根据公司规定... [1]",
  "sources": [
    {
      "id": "kb_123",
      "title": "员工手册 v2",
      "snippet": "年假天数...",
      "score": 0.85
    }
  ],
  "metadata": {
    "retrieval_time_ms": 230,
    "llm_time_ms": 1450,
    "strategy": "hybrid"
  }
}
```

### 10.4 目录结构

```
backend/
├── main.py
├── config.py
├── requirements.txt
├── Dockerfile
├── .env.example
├── app/
│   ├── api/
│   ├── core/
│   ├── models/
│   ├── schemas/
│   ├── services/
│   ├── db/
│   ├── middleware/
│   └── utils/
├── celery_app/
├── scripts/
├── tests/
└── logs/
```

---

<div align="center">

**📧 技术支持**: dev-team@your-company.com  
**📝 版本**: v1.0.0 · 更新时间 2025-01-XX

</div>

