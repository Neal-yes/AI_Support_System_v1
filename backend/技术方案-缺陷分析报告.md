# åç«¯æŠ€æœ¯æ–¹æ¡ˆ - ç¼ºé™·åˆ†ææŠ¥å‘Š

<div align="center">

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ†ææ—¥æœŸ**: 2025-01-05  
**åˆ†æäºº**: AI Assistant

</div>

---

## ğŸ“‹ ç›®å½•

- [1. æ€»ä½“è¯„ä¼°](#1-æ€»ä½“è¯„ä¼°)
- [2. å…³é”®ç¼ºé™·](#2-å…³é”®ç¼ºé™·)
- [3. æ¥å£å¯¹ç…§é—®é¢˜](#3-æ¥å£å¯¹ç…§é—®é¢˜)
- [4. æ•°æ®åº“è®¾è®¡é—®é¢˜](#4-æ•°æ®åº“è®¾è®¡é—®é¢˜)
- [5. æŠ€æœ¯æ–¹æ¡ˆé—æ¼](#5-æŠ€æœ¯æ–¹æ¡ˆé—æ¼)
- [6. éƒ¨ç½²é…ç½®ä¸è¶³](#6-éƒ¨ç½²é…ç½®ä¸è¶³)
- [7. ä¼˜åŒ–å»ºè®®](#7-ä¼˜åŒ–å»ºè®®)
- [8. ä¿®å¤ä¼˜å…ˆçº§](#8-ä¿®å¤ä¼˜å…ˆçº§)

---

## 1. æ€»ä½“è¯„ä¼°

### 1.1 æ–‡æ¡£è´¨é‡

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **å®Œæ•´æ€§** | â­â­â­â­ | 4/5 - è¦†ç›–ä¸»è¦æ¨¡å—ï¼Œä½†æœ‰é—æ¼ |
| **å‡†ç¡®æ€§** | â­â­â­â­ | 4/5 - å¤§éƒ¨åˆ†å‡†ç¡®ï¼Œå­˜åœ¨ä¸ä¸€è‡´ |
| **å¯å®æ–½æ€§** | â­â­â­â­ | 4/5 - æŠ€æœ¯é€‰å‹åˆç†ï¼Œç¼ºå°‘ç»†èŠ‚ |
| **ä¸å‰ç«¯å¯¹æ¥** | â­â­â­â˜† | 3.5/5 - éƒ¨åˆ†æ¥å£ä¸åŒ¹é… |

### 1.2 ä¸»è¦é—®é¢˜

- âŒ **æ¥å£å®šä¹‰ä¸ä¸€è‡´**ï¼šæŠ€æœ¯æ–¹æ¡ˆ52ä¸ªæ¥å£ vs OpenAPIè§„èŒƒ40ä¸ªæ¥å£
- âŒ **ç¼ºå°‘å…³é”®æ¥å£**ï¼šéƒ¨åˆ†å‰ç«¯éœ€è¦çš„æ¥å£æœªåœ¨OpenAPIä¸­å®šä¹‰
- âš ï¸ **é…ç½®ç¤ºä¾‹ä¸å®Œæ•´**ï¼šDockerã€Nginxé…ç½®ç¼ºå°‘å…·ä½“å†…å®¹
- âš ï¸ **æµ‹è¯•ç­–ç•¥ç¼ºå¤±**ï¼šæ²¡æœ‰æµ‹è¯•è®¡åˆ’å’Œè´¨é‡ä¿è¯è¯´æ˜
- âš ï¸ **éƒ¨åˆ†ç»†èŠ‚æ¨¡ç³Š**ï¼šRAGå®ç°ç»†èŠ‚ã€æ¨¡å‹é…ç½®ç­‰

---

## 2. å…³é”®ç¼ºé™·

### 2.1 æ¥å£æ•°é‡ä¸åŒ¹é… âŒ

**é—®é¢˜æè¿°**ï¼š
- æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£æåˆ° **52ä¸ªæ¥å£**
- OpenAPIè§„èŒƒåªå®šä¹‰äº† **40ä¸ªæ¥å£**
- **ç¼ºå°‘12ä¸ªæ¥å£å®šä¹‰**

**å½±å“**ï¼š
- å‰åç«¯è”è°ƒæ—¶ä¼šå‘ç°æ¥å£ç¼ºå¤±
- å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦åå¤ä¿®æ”¹APIæ–‡æ¡£
- å¢åŠ æ²Ÿé€šæˆæœ¬å’Œå¼€å‘é£é™©

**å»ºè®®**ï¼š
- éœ€è¦è¡¥å……ç¼ºå¤±çš„12ä¸ªæ¥å£åˆ°OpenAPIè§„èŒƒ
- æˆ–è€…ä»æŠ€æœ¯æ–¹æ¡ˆä¸­ç§»é™¤å¤šä½™çš„æ¥å£è¯´æ˜

---

### 2.2 è®¤è¯æ¨¡å—æ¥å£ä¸ä¸€è‡´ âŒ

**æŠ€æœ¯æ–¹æ¡ˆä¸­æåˆ°**ï¼š
```
POST   /api/auth/login        # ç™»å½•
POST   /api/auth/logout       # ç™»å‡º
GET    /api/auth/verify       # éªŒè¯ Token
POST   /api/auth/refresh      # åˆ·æ–° Token â† ç¼ºå¤±
```

**OpenAPIä¸­å®šä¹‰**ï¼š
```yaml
/auth/login     âœ…
/auth/logout    âœ…
/auth/verify    âœ…
/auth/refresh   âŒ æœªå®šä¹‰
```

**é—®é¢˜**ï¼š
- Tokenåˆ·æ–°æœºåˆ¶åœ¨æŠ€æœ¯æ–¹æ¡ˆä¸­æåˆ°ï¼Œä½†OpenAPIä¸­æ²¡æœ‰å®šä¹‰
- å‰ç«¯æ— æ³•è°ƒç”¨åˆ·æ–°Tokenæ¥å£

**ä¿®å¤**ï¼š
éœ€è¦åœ¨OpenAPIä¸­æ·»åŠ ï¼š
```yaml
/auth/refresh:
  post:
    tags:
      - è®¤è¯
    summary: åˆ·æ–°Token
    security:
      - bearerAuth: []
```

---

### 2.3 å¯¹è¯æ¨¡å—æ¥å£ç¼ºå¤± âŒ

**æŠ€æœ¯æ–¹æ¡ˆä¸­æåˆ°**ï¼š
```
POST   /api/chat/feedback     # ç”¨æˆ·åé¦ˆï¼ˆç‚¹èµ/ç‚¹è¸©ï¼‰â† ç¼ºå¤±
```

**OpenAPIä¸­**ï¼š
- âŒ æ²¡æœ‰å®šä¹‰åé¦ˆæ¥å£

**å½±å“**ï¼š
- å‰ç«¯æ— æ³•å®ç°ç‚¹èµ/ç‚¹è¸©åŠŸèƒ½
- æ— æ³•æ”¶é›†ç”¨æˆ·å¯¹å›ç­”è´¨é‡çš„åé¦ˆ
- å½±å“RAGç³»ç»Ÿçš„æŒç»­ä¼˜åŒ–

**ä¿®å¤**ï¼š
éœ€è¦æ·»åŠ åé¦ˆæ¥å£å®šä¹‰å’Œæ•°æ®è¡¨ã€‚

---

### 2.4 çŸ¥è¯†åº“æ¥å£ä¸ä¸€è‡´ âš ï¸

**æŠ€æœ¯æ–¹æ¡ˆä¸­æåˆ°**ï¼š
```
GET    /api/knowledge/preview/:id    # é¢„è§ˆçŸ¥è¯† â† ç¼ºå¤±
POST   /api/knowledge/reindex        # é‡å»ºç´¢å¼• â† ç¼ºå¤±
```

**OpenAPIä¸­**ï¼š
- âŒ æ²¡æœ‰é¢„è§ˆæ¥å£ï¼ˆå‰ç«¯æœ‰é¢„è§ˆåŠŸèƒ½éœ€æ±‚ï¼‰
- âŒ æ²¡æœ‰é‡å»ºç´¢å¼•æ¥å£ï¼ˆé‡è¦è¿ç»´åŠŸèƒ½ï¼‰

**ä¿®å¤**ï¼š
éœ€è¦è¡¥å……è¿™ä¸¤ä¸ªæ¥å£çš„å®šä¹‰ã€‚

---

### 2.5 ç”¨æˆ·ç®¡ç†æ¥å£è·¯å¾„ä¸ä¸€è‡´ âš ï¸

**æŠ€æœ¯æ–¹æ¡ˆä¸­**ï¼š
```
GET    /api/users/list
POST   /api/users/add
PUT    /api/users/update/:id
DELETE /api/users/delete/:id
POST   /api/users/reset-password
```

**OpenAPIä¸­**ï¼š
```yaml
GET    /api/users/admins        â† è·¯å¾„ä¸åŒ
POST   /api/users/admins        â† è·¯å¾„ä¸åŒ
PUT    /api/users/admins/{id}   â† è·¯å¾„ä¸åŒ
DELETE /api/users/admins/{id}   â† è·¯å¾„ä¸åŒ
POST   /api/users/admins/{id}/reset-password â† è·¯å¾„ä¸åŒ
```

**é—®é¢˜**ï¼š
- è·¯å¾„å‘½åä¸ä¸€è‡´
- å¯èƒ½å¯¼è‡´å‰åç«¯ç†è§£åå·®

**å»ºè®®**ï¼š
- ç»Ÿä¸€ä½¿ç”¨ `/api/users/admins` è·¯å¾„
- æ›´æ–°æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£ä»¥ä¿æŒä¸€è‡´

---

## 3. æ¥å£å¯¹ç…§é—®é¢˜

### 3.1 ç¼ºå¤±çš„æ¥å£æ¸…å•

æ ¹æ®å¯¹æ¯”ï¼Œä»¥ä¸‹æ¥å£åœ¨æŠ€æœ¯æ–¹æ¡ˆä¸­æåˆ°ï¼Œä½†OpenAPIä¸­æœªå®šä¹‰ï¼š

| åºå· | æ¥å£ | æ¨¡å— | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| 1 | `POST /api/auth/refresh` | è®¤è¯ | ğŸ”´ P0 |
| 2 | `POST /api/chat/feedback` | å¯¹è¯ | ğŸŸ¡ P1 |
| 3 | `GET /api/knowledge/preview/:id` | çŸ¥è¯†åº“ | ğŸŸ¡ P1 |
| 4 | `POST /api/knowledge/reindex` | çŸ¥è¯†åº“ | ğŸŸ  P2 |
| 5 | `POST /api/mysql/execute` | MySQL | ğŸ”´ P0 |
| 6 | `POST /api/users/assign-role` | ç”¨æˆ·ç®¡ç† | ğŸŸ¡ P1 |

### 3.2 å»ºè®®è¡¥å……çš„æ¥å£

åŸºäºå®Œæ•´æ€§è€ƒè™‘ï¼Œå»ºè®®è¡¥å……ä»¥ä¸‹æ¥å£ï¼š

| æ¥å£ | è¯´æ˜ | åŸå›  |
|------|------|------|
| `GET /api/health` | å¥åº·æ£€æŸ¥ | è¿ç»´å¿…éœ€ |
| `GET /api/metrics` | PrometheusæŒ‡æ ‡ | ç›‘æ§å¿…éœ€ |
| `POST /api/knowledge/batch-delete` | æ‰¹é‡åˆ é™¤çŸ¥è¯† | æå‡æ•ˆç‡ |
| `GET /api/analytics/trends` | è¶‹åŠ¿åˆ†æ | æ•°æ®æ´å¯Ÿ |

---

## 4. æ•°æ®åº“è®¾è®¡é—®é¢˜

### 4.1 å­—æ®µå®šä¹‰ä¸å®Œæ•´ âš ï¸

**é—®é¢˜1ï¼šknowledge_baseè¡¨ç¼ºå°‘å­—æ®µ**

æŠ€æœ¯æ–¹æ¡ˆä¸­å®šä¹‰ï¼š
```sql
CREATE TABLE knowledge_base (
    ...
    version INT DEFAULT 1
);
```

ä½†OpenAPI Schemaä¸­æœ‰ï¼š
```yaml
Knowledge:
  properties:
    viewCount: integer  # æ•°æ®åº“è¡¨ä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ âŒ
```

**ä¿®å¤**ï¼š
éœ€è¦åœ¨æ•°æ®åº“è¡¨ä¸­æ·»åŠ  `view_count INT DEFAULT 0`ã€‚

---

**é—®é¢˜2ï¼šfeedbackè¡¨å®šä¹‰ä¸å®Œæ•´**

æŠ€æœ¯æ–¹æ¡ˆä¸­å®šä¹‰äº†`feedback`è¡¨ï¼Œä½†ï¼š
- âŒ OpenAPIä¸­æ²¡æœ‰å¯¹åº”çš„Feedback Schema
- âŒ æ²¡æœ‰å®šä¹‰åé¦ˆç±»å‹çš„æšä¸¾å€¼ï¼ˆlikeã€dislikeã€flagç­‰ï¼‰

---

### 4.2 ç¼ºå°‘çš„æ•°æ®è¡¨ âŒ

OpenAPIä¸­å®šä¹‰äº†æ•°æ®æ¨¡å‹ï¼Œä½†æ•°æ®åº“è®¾è®¡ä¸­ç¼ºå°‘ï¼š

| Schemaåç§° | æ•°æ®åº“è¡¨ | çŠ¶æ€ |
|-----------|----------|------|
| `Conversation` | âœ… conversations | æœ‰ |
| `Message` | âœ… messages | æœ‰ |
| `Knowledge` | âœ… knowledge_base | æœ‰ |
| `Intent` | âœ… intents | æœ‰ |
| `SQLStatement` | âœ… sql_templates | æœ‰ |
| `Department` | âœ… departments | æœ‰ |
| `Admin` | âœ… users | æœ‰ |
| `Role` | âœ… roles | æœ‰ |
| `LoginLog` | âœ… login_logs | æœ‰ |
| `AuditLog` | âš ï¸ permission_audit_logs | åç§°ä¸ä¸€è‡´ |
| `Metrics` | âŒ ç¼ºå¤± | æ— æŒä¹…åŒ–è¡¨ |

---

### 4.3 ç´¢å¼•ä¼˜åŒ–ä¸è¶³ âš ï¸

æŠ€æœ¯æ–¹æ¡ˆåªåˆ—å‡ºäº†6ä¸ªåŸºç¡€ç´¢å¼•ï¼Œä½†å®é™…éœ€è¦æ›´å¤šï¼š

**å»ºè®®è¡¥å……çš„ç´¢å¼•**ï¼š
```sql
-- å¯¹è¯æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_conversations_user_updated ON conversations(user_id, updated_at DESC);

-- æ¶ˆæ¯æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_messages_conversation_created ON messages(conversation_id, created_at);

-- çŸ¥è¯†åº“å¤šç»´æŸ¥è¯¢
CREATE INDEX idx_kb_category_status ON knowledge_base(category, status);
CREATE INDEX idx_kb_department ON knowledge_base(department_id);

-- æ—¥å¿—æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_retrieval_logs_message ON retrieval_logs(message_id);
CREATE INDEX idx_sql_logs_user_created ON sql_execution_logs(user_id, created_at DESC);

-- å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆPostgreSQLï¼‰
CREATE INDEX idx_kb_title_fulltext ON knowledge_base USING gin(to_tsvector('chinese', title));
CREATE INDEX idx_kb_content_fulltext ON knowledge_base USING gin(to_tsvector('chinese', content));
```

---

## 5. æŠ€æœ¯æ–¹æ¡ˆé—æ¼

### 5.1 RAGå®ç°ç»†èŠ‚ä¸è¶³ âš ï¸

**ç¼ºå°‘çš„å…³é”®ä¿¡æ¯**ï¼š

1. **Haystack Pipelineä»£ç ç¤ºä¾‹**
   - âŒ æ²¡æœ‰å®Œæ•´çš„Pipelineæ„å»ºä»£ç 
   - âŒ æ²¡æœ‰è¯´æ˜å„ç»„ä»¶çš„å…·ä½“é…ç½®å‚æ•°

**å»ºè®®è¡¥å……**ï¼š
```python
from haystack import Pipeline
from haystack.components.retrievers import QdrantRetriever
from haystack.components.rankers import TransformersSimilarityRanker

pipeline = Pipeline()
pipeline.add_component("retriever", QdrantRetriever(...))
pipeline.add_component("reranker", TransformersSimilarityRanker(...))
pipeline.connect("retriever", "reranker")
```

---

2. **å‘é‡ç»´åº¦å’Œè·ç¦»åº¦é‡**
   - âš ï¸ åªè¯´äº†`vector_size: 1024`ï¼Œæ²¡è¯´æ˜åº¦é‡æ–¹å¼
   - âŒ æ²¡æœ‰è¯´æ˜Qdrant collectionçš„å…·ä½“é…ç½®

**å»ºè®®è¡¥å……**ï¼š
```python
from qdrant_client.models import Distance, VectorParams

collection_config = VectorParams(
    size=1024,
    distance=Distance.COSINE  # æˆ– Distance.DOT æˆ– Distance.EUCLID
)
```

---

3. **Embeddingæ¨¡å‹é…ç½®**
   - âš ï¸ è¯´ä½¿ç”¨bge-m3ï¼Œä½†æ²¡è¯´æ˜ï¼š
     - æ¨¡å‹ä¸‹è½½è·¯å¾„
     - æ˜¯å¦ä½¿ç”¨å¤šè¯­è¨€èƒ½åŠ›
     - æ˜¯å¦å¯ç”¨ç¨ å¯†+ç¨€ç–+colbertä¸‰ç§æ¨¡å¼

**å»ºè®®è¡¥å……**ï¼š
```python
from sentence_transformers import SentenceTransformer

model = SentenceTransformer(
    "BAAI/bge-m3",
    device="cpu",  # æˆ– "cuda"
    cache_folder="/app/models"
)

# bge-m3 æ”¯æŒä¸‰ç§embeddingæ¨¡å¼
embeddings = model.encode(
    texts,
    return_dense=True,    # 1024ç»´ç¨ å¯†å‘é‡
    return_sparse=False,  # ç¨€ç–å‘é‡ï¼ˆå¯é€‰ï¼‰
    return_colbert_vecs=False  # ColBERTå‘é‡ï¼ˆå¯é€‰ï¼‰
)
```

---

### 5.2 Ollamaé…ç½®ä¸è¯¦ç»† âš ï¸

**ç¼ºå°‘çš„é…ç½®è¯´æ˜**ï¼š

1. **æ¨¡å‹ä¸‹è½½å’Œç®¡ç†**
   - âŒ æ²¡æœ‰è¯´æ˜å¦‚ä½•ä¸‹è½½æ¨¡å‹
   - âŒ æ²¡æœ‰è¯´æ˜æ¨¡å‹å­˜å‚¨ä½ç½®
   - âŒ æ²¡æœ‰è¯´æ˜æ˜¯å¦éœ€è¦GPU

**å»ºè®®è¡¥å……**ï¼š
```bash
# ä¸‹è½½æ¨¡å‹
ollama pull qwen2.5:14b-instruct

# æŸ¥çœ‹å·²å®‰è£…æ¨¡å‹
ollama list

# æ¨¡å‹å­˜å‚¨ä½ç½®
# Linux: ~/.ollama/models
# macOS: ~/.ollama/models
# Docker: /root/.ollama/models
```

---

2. **æ€§èƒ½å‚æ•°è°ƒä¼˜**
   - âš ï¸ åªåˆ—å‡ºäº†åŸºç¡€å‚æ•°ï¼Œç¼ºå°‘æ€§èƒ½ç›¸å…³é…ç½®

**å»ºè®®è¡¥å……**ï¼š
```yaml
# Modelfile é…ç½®
FROM qwen2.5:14b-instruct

# æ€§èƒ½å‚æ•°
PARAMETER num_ctx 4096        # ä¸Šä¸‹æ–‡é•¿åº¦
PARAMETER num_gpu 1           # GPUå±‚æ•°
PARAMETER num_thread 8        # CPUçº¿ç¨‹æ•°
PARAMETER repeat_penalty 1.1  # é‡å¤æƒ©ç½š
PARAMETER stop "<|im_end|>"   # åœæ­¢ç¬¦
```

---

### 5.3 æ–‡ä»¶ä¸Šä¼ å¤„ç†ä¸å®Œæ•´ âš ï¸

æŠ€æœ¯æ–¹æ¡ˆæåˆ°æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼ï¼Œä½†ç¼ºå°‘ï¼š

1. **æ–‡ä»¶å¤§å°é™åˆ¶**
   - âŒ æ²¡æœ‰è¯´æ˜å•ä¸ªæ–‡ä»¶å¤§å°é™åˆ¶
   - âŒ æ²¡æœ‰è¯´æ˜æ‰¹é‡å¯¼å…¥çš„æ–‡ä»¶æ•°é‡é™åˆ¶

**å»ºè®®è¡¥å……**ï¼š
```python
# FastAPI æ–‡ä»¶ä¸Šä¼ é…ç½®
from fastapi import File, UploadFile

MAX_FILE_SIZE = 50 * 1024 * 1024  # 50MB
MAX_FILES_PER_BATCH = 20
ALLOWED_EXTENSIONS = {'.pdf', '.docx', '.pptx', '.md', '.txt', '.csv', '.xlsx'}

@app.post("/api/knowledge/import")
async def import_knowledge(files: List[UploadFile] = File(...)):
    if len(files) > MAX_FILES_PER_BATCH:
        raise HTTPException(400, "æœ€å¤šä¸Šä¼ 20ä¸ªæ–‡ä»¶")
    
    for file in files:
        if file.size > MAX_FILE_SIZE:
            raise HTTPException(400, f"{file.filename}è¶…è¿‡50MBé™åˆ¶")
```

---

2. **æ–‡ä»¶å­˜å‚¨ç­–ç•¥**
   - âŒ æ²¡æœ‰è¯´æ˜åŸå§‹æ–‡ä»¶æ˜¯å¦ä¿ç•™
   - âŒ æ²¡æœ‰è¯´æ˜æ–‡ä»¶å­˜å‚¨è·¯å¾„è§„åˆ’

**å»ºè®®è¡¥å……**ï¼š
```python
# æ–‡ä»¶å­˜å‚¨ç»“æ„
uploads/
â”œâ”€â”€ knowledge/
â”‚   â”œâ”€â”€ 2025/
â”‚   â”‚   â”œâ”€â”€ 01/
â”‚   â”‚   â”‚   â”œâ”€â”€ original/     # åŸå§‹æ–‡ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ processed/    # å¤„ç†åæ–‡ä»¶
```

---

### 5.4 å®‰å…¨æœºåˆ¶ä¸è¯¦ç»† âš ï¸

æŠ€æœ¯æ–¹æ¡ˆåˆ—å‡ºäº†å®‰å…¨æªæ–½ï¼Œä½†ç¼ºå°‘å…·ä½“å®ç°ï¼š

1. **SQLæ³¨å…¥é˜²æŠ¤**
   - âš ï¸ åªè¯´äº†"å‚æ•°åŒ–"ï¼Œæ²¡æœ‰ä»£ç ç¤ºä¾‹

**å»ºè®®è¡¥å……**ï¼š
```python
from sqlalchemy import text

# âŒ å±é™©ï¼šå­—ç¬¦ä¸²æ‹¼æ¥
query = f"SELECT * FROM users WHERE id = {user_input}"

# âœ… å®‰å…¨ï¼šå‚æ•°åŒ–æŸ¥è¯¢
query = text("SELECT * FROM users WHERE id = :user_id")
result = session.execute(query, {"user_id": user_input})
```

---

2. **é€Ÿç‡é™åˆ¶**
   - âš ï¸ æåˆ°äº†é™æµï¼Œä½†æ²¡æœ‰å…·ä½“å®ç°

**å»ºè®®è¡¥å……**ï¼š
```python
from slowapi import Limiter
from slowapi.util import get_remote_address

limiter = Limiter(key_func=get_remote_address)

@app.post("/api/chat/message")
@limiter.limit("20/minute")  # æ¯åˆ†é’Ÿ20æ¬¡
async def send_message(...):
    pass
```

---

3. **CORSé…ç½®**
   - âŒ å®Œå…¨æ²¡æœ‰æåˆ°CORSé…ç½®

**å»ºè®®è¡¥å……**ï¼š
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # å‰ç«¯åœ°å€
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

### 5.5 ç¼ºå°‘æµ‹è¯•ç­–ç•¥ âŒ

æŠ€æœ¯æ–¹æ¡ˆå®Œå…¨æ²¡æœ‰æåˆ°æµ‹è¯•ï¼š

**å»ºè®®è¡¥å……**ï¼š

1. **å•å…ƒæµ‹è¯•**
```python
# tests/test_rag.py
import pytest

def test_hybrid_retrieval():
    # æµ‹è¯•æ··åˆæ£€ç´¢
    pass

def test_reranking():
    # æµ‹è¯•é‡æ’åº
    pass
```

2. **é›†æˆæµ‹è¯•**
```python
# tests/integration/test_chat_api.py
def test_send_message_with_knowledge():
    # æµ‹è¯•å®Œæ•´çš„å¯¹è¯æµç¨‹
    pass
```

3. **æ€§èƒ½æµ‹è¯•**
```bash
# ä½¿ç”¨ locust è¿›è¡Œå‹åŠ›æµ‹è¯•
locust -f tests/load/test_chat.py
```

---

## 6. éƒ¨ç½²é…ç½®ä¸è¶³

### 6.1 Dockeré…ç½®ä¸å®Œæ•´ âš ï¸

æŠ€æœ¯æ–¹æ¡ˆåªåˆ—å‡ºäº†docker-composeçš„æœåŠ¡åç§°ï¼Œä½†ç¼ºå°‘ï¼š

1. **å®Œæ•´çš„docker-compose.yml**

**å»ºè®®è¡¥å……å®Œæ•´é…ç½®**ï¼š
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ai_support_system
      POSTGRES_USER: ai_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"

  qdrant:
    image: qdrant/qdrant:v1.11.0
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "6333:6333"
      - "6334:6334"

  opensearch:
    image: opensearchproject/opensearch:2.13.0
    environment:
      - discovery.type=single-node
      - "OPENSEARCH_JAVA_OPTS=-Xms2g -Xmx2g"
      - plugins.security.disabled=true
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    ports:
      - "9200:9200"

  ollama:
    image: ollama/ollama:latest
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"

  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://ai_user:${DB_PASSWORD}@postgres:5432/ai_support_system
      - REDIS_URL=redis://redis:6379/0
      - QDRANT_URL=http://qdrant:6333
      - OPENSEARCH_URL=http://opensearch:9200
      - OLLAMA_URL=http://ollama:11434
    depends_on:
      - postgres
      - redis
      - qdrant
      - opensearch
      - ollama
    ports:
      - "8080:8080"
    volumes:
      - ./backend:/app
      - models_cache:/app/models

  celery:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A celery_app worker -l info
    environment:
      - DATABASE_URL=postgresql://ai_user:${DB_PASSWORD}@postgres:5432/ai_support_system
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - postgres
      - redis

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../frontend/dist:/usr/share/nginx/html:ro
    ports:
      - "80:80"
    depends_on:
      - api

volumes:
  postgres_data:
  redis_data:
  qdrant_data:
  opensearch_data:
  ollama_data:
  models_cache:
```

---

2. **Dockerfileç¼ºå¤±**

**å»ºè®®è¡¥å……**ï¼š
```dockerfile
# backend/Dockerfile
FROM python:3.10-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]
```

---

3. **Nginxé…ç½®ç¼ºå¤±**

**å»ºè®®è¡¥å……**ï¼š
```nginx
# nginx/nginx.conf
user nginx;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/javascript application/json;

    # åç«¯æœåŠ¡å™¨
    upstream backend {
        server api:8080;
    }

    server {
        listen 80;
        server_name localhost;

        # å‰ç«¯é™æ€æ–‡ä»¶
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # APIä»£ç†
        location /api {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            access_log off;
            return 200 "healthy\n";
        }
    }
}
```

---

### 6.2 ç¯å¢ƒå˜é‡ä¸å®Œæ•´ âš ï¸

æŠ€æœ¯æ–¹æ¡ˆåˆ—å‡ºäº†ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œä½†ç¼ºå°‘ï¼š

**å»ºè®®è¡¥å……**ï¼š
```bash
# .env.example

# ==================== åº”ç”¨é…ç½® ====================
APP_ENV=development
APP_NAME=AI_Support_System
API_PORT=8080
API_HOST=0.0.0.0
LOG_LEVEL=INFO

# ==================== æ•°æ®åº“é…ç½® ====================
DATABASE_URL=postgresql://ai_user:password@postgres:5432/ai_support_system
DB_POOL_SIZE=20
DB_MAX_OVERFLOW=10

# ==================== Redisé…ç½® ====================
REDIS_URL=redis://redis:6379/0
REDIS_PASSWORD=
REDIS_DB=0

# ==================== å‘é‡åº“é…ç½® ====================
QDRANT_URL=http://qdrant:6333
QDRANT_API_KEY=
QDRANT_COLLECTION=knowledge_base

# ==================== æœç´¢å¼•æ“é…ç½® ====================
OPENSEARCH_URL=http://opensearch:9200
OPENSEARCH_USER=admin
OPENSEARCH_PASSWORD=admin
OPENSEARCH_INDEX=knowledge_base

# ==================== Ollamaé…ç½® ====================
OLLAMA_URL=http://ollama:11434
OLLAMA_MODEL=qwen2.5:14b-instruct
OLLAMA_TEMPERATURE=0.7
OLLAMA_MAX_TOKENS=512
OLLAMA_TIMEOUT=60

# ==================== Embeddingæ¨¡å‹é…ç½® ====================
EMBEDDING_MODEL_NAME=BAAI/bge-m3
EMBEDDING_MODEL_PATH=/app/models/bge-m3
EMBEDDING_DEVICE=cpu
EMBEDDING_BATCH_SIZE=32

# ==================== Rerankeré…ç½® ====================
RERANKER_MODEL_NAME=BAAI/bge-reranker-large
RERANKER_MODEL_PATH=/app/models/bge-reranker-large
RERANKER_DEVICE=cpu
RERANKER_MAX_LENGTH=512

# ==================== JWTé…ç½® ====================
JWT_SECRET_KEY=your-secret-key-change-in-production
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=120
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7

# ==================== CORSé…ç½® ====================
CORS_ORIGINS=http://localhost:3000,http://localhost:3001
CORS_ALLOW_CREDENTIALS=true

# ==================== æ–‡ä»¶ä¸Šä¼ é…ç½® ====================
UPLOAD_DIR=/app/uploads
MAX_FILE_SIZE=52428800  # 50MB
MAX_FILES_PER_BATCH=20
ALLOWED_EXTENSIONS=.pdf,.docx,.pptx,.md,.txt,.csv,.xlsx

# ==================== RAGé…ç½® ====================
ENABLE_MULTI_QUERY=true
ENABLE_HYDE=true
MULTI_QUERY_TRIGGER_THRESHOLD=0.6
RETRIEVAL_TOP_K_BM25=20
RETRIEVAL_TOP_K_VECTOR=20
RERANK_TOP_K=8
MIN_CONFIDENCE_SCORE=0.3

# ==================== é€Ÿç‡é™åˆ¶ ====================
RATE_LIMIT_ENABLED=true
RATE_LIMIT_PER_MINUTE=20
RATE_LIMIT_PER_HOUR=100

# ==================== Celeryé…ç½® ====================
CELERY_BROKER_URL=redis://redis:6379/1
CELERY_RESULT_BACKEND=redis://redis:6379/2
CELERY_TASK_SERIALIZER=json
CELERY_ACCEPT_CONTENT=json

# ==================== ç›‘æ§é…ç½® ====================
ENABLE_METRICS=true
METRICS_PORT=9090
ENABLE_TRACING=false
JAEGER_ENDPOINT=http://jaeger:14268/api/traces

# ==================== ç¬¬ä¸‰æ–¹æ¥å£ ====================
WECHAT_CORP_ID=
WECHAT_CORP_SECRET=
DINGTALK_APP_KEY=
DINGTALK_APP_SECRET=
OA_API_URL=
OA_API_KEY=
```

---

## 7. ä¼˜åŒ–å»ºè®®

### 7.1 æ–‡æ¡£ç»“æ„ä¼˜åŒ– ğŸ“

**å»ºè®®è°ƒæ•´**ï¼š

1. **å¢åŠ "å¿«é€Ÿå¼€å§‹"ç« èŠ‚**
   - 5åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²æŒ‡å—
   - Hello World APIç¤ºä¾‹
   - å¸¸è§é—®é¢˜FAQ

2. **å¢åŠ "å¼€å‘æŒ‡å—"ç« èŠ‚**
   - é¡¹ç›®ç»“æ„è¯¦è§£
   - ä»£ç è§„èŒƒ
   - Gitå·¥ä½œæµ
   - PRæ¨¡æ¿

3. **å¢åŠ "APIç‰ˆæœ¬æ§åˆ¶"è¯´æ˜**
```python
# æ”¯æŒç‰ˆæœ¬æ§åˆ¶
@app.get("/api/v1/chat/message")  # v1ç‰ˆæœ¬
@app.get("/api/v2/chat/message")  # v2ç‰ˆæœ¬
```

---

### 7.2 æ€§èƒ½ä¼˜åŒ–è¡¥å…… âš¡

**å»ºè®®è¡¥å……**ï¼š

1. **è¿æ¥æ± é…ç½®**
```python
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

engine = create_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=20,
    max_overflow=10,
    pool_timeout=30,
    pool_recycle=3600
)
```

2. **ç¼“å­˜ç­–ç•¥ç»†åŒ–**
```python
# Redisç¼“å­˜å±‚çº§
cache_config = {
    "hot_queries": {
        "ttl": 3600,      # çƒ­é—¨æŸ¥è¯¢ç¼“å­˜1å°æ—¶
        "max_size": 1000
    },
    "user_sessions": {
        "ttl": 7200,      # ä¼šè¯ç¼“å­˜2å°æ—¶
        "max_size": 10000
    },
    "embeddings": {
        "ttl": 86400,     # Embeddingç¼“å­˜1å¤©
        "max_size": 5000
    }
}
```

---

### 7.3 å¯è§‚æµ‹æ€§å¢å¼º ğŸ“Š

**å»ºè®®è¡¥å……**ï¼š

1. **ç»“æ„åŒ–æ—¥å¿—**
```python
from loguru import logger

logger.add(
    "logs/api_{time}.log",
    rotation="1 day",
    retention="30 days",
    level="INFO",
    format="{time} | {level} | {module}:{function}:{line} | {message}",
    serialize=True  # JSONæ ¼å¼
)
```

2. **è‡ªå®šä¹‰Metrics**
```python
from prometheus_client import Counter, Histogram

# è‡ªå®šä¹‰æŒ‡æ ‡
rag_requests_total = Counter(
    'rag_requests_total',
    'Total RAG requests',
    ['strategy', 'status']
)

rag_latency = Histogram(
    'rag_latency_seconds',
    'RAG processing latency',
    ['strategy']
)
```

---

## 8. ä¿®å¤ä¼˜å…ˆçº§

### 8.1 P0 - å¿…é¡»ç«‹å³ä¿®å¤ ğŸ”´

| åºå· | é—®é¢˜ | å½±å“ | ä¿®å¤æ—¶é—´ |
|------|------|------|----------|
| 1 | è¡¥å……ç¼ºå¤±çš„12ä¸ªæ¥å£åˆ°OpenAPI | å‰åç«¯æ— æ³•è”è°ƒ | 2å°æ—¶ |
| 2 | ç»Ÿä¸€æ¥å£è·¯å¾„å‘½å | ç†è§£åå·® | 1å°æ—¶ |
| 3 | è¡¥å……Tokenåˆ·æ–°æ¥å£ | ç”¨æˆ·ä½“éªŒå·® | 1å°æ—¶ |
| 4 | è¡¥å……å®Œæ•´çš„docker-compose.yml | æ— æ³•éƒ¨ç½² | 2å°æ—¶ |
| 5 | è¡¥å……Dockerfile | æ— æ³•æ„å»º | 1å°æ—¶ |

**æ€»è®¡**: çº¦7å°æ—¶

---

### 8.2 P1 - åº”å°½å¿«ä¿®å¤ ğŸŸ¡

| åºå· | é—®é¢˜ | å½±å“ | ä¿®å¤æ—¶é—´ |
|------|------|------|----------|
| 1 | è¡¥å……ç”¨æˆ·åé¦ˆæ¥å£ | æ— æ³•æ”¶é›†åé¦ˆ | 1å°æ—¶ |
| 2 | è¡¥å……çŸ¥è¯†åº“é¢„è§ˆæ¥å£ | åŠŸèƒ½ç¼ºå¤± | 1å°æ—¶ |
| 3 | è¡¥å……å®Œæ•´ç¯å¢ƒå˜é‡é…ç½® | é…ç½®æ··ä¹± | 2å°æ—¶ |
| 4 | è¡¥å……Nginxé…ç½®æ–‡ä»¶ | æ— æ³•ä»£ç† | 1å°æ—¶ |
| 5 | å®Œå–„æ•°æ®åº“ç´¢å¼• | æ€§èƒ½é—®é¢˜ | 2å°æ—¶ |
| 6 | è¡¥å……CORSé…ç½® | å‰ç«¯è·¨åŸŸ | 0.5å°æ—¶ |

**æ€»è®¡**: çº¦7.5å°æ—¶

---

### 8.3 P2 - å¯å»¶åä¿®å¤ ğŸŸ 

| åºå· | é—®é¢˜ | å½±å“ | ä¿®å¤æ—¶é—´ |
|------|------|------|----------|
| 1 | è¡¥å……RAG Pipelineä»£ç ç¤ºä¾‹ | å®ç°ç»†èŠ‚ä¸æ¸… | 3å°æ—¶ |
| 2 | è¡¥å……æµ‹è¯•ç­–ç•¥ | è´¨é‡ä¿éšœå¼± | 4å°æ—¶ |
| 3 | è¡¥å……Ollamaè¯¦ç»†é…ç½® | æ€§èƒ½ä¼˜åŒ–å—é™ | 2å°æ—¶ |
| 4 | è¡¥å……æ–‡ä»¶ä¸Šä¼ è¯¦ç»†è¯´æ˜ | åŠŸèƒ½é™åˆ¶ä¸æ˜ | 1å°æ—¶ |
| 5 | è¡¥å……å®‰å…¨æœºåˆ¶ä»£ç ç¤ºä¾‹ | å®‰å…¨å®ç°ä¸æ¸… | 2å°æ—¶ |

**æ€»è®¡**: çº¦12å°æ—¶

---

## 9. æ€»ç»“

### 9.1 æ•´ä½“è¯„ä»·

åç«¯æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£**æ•´ä½“è´¨é‡è‰¯å¥½**ï¼Œä½†å­˜åœ¨ä»¥ä¸‹ä¸»è¦é—®é¢˜ï¼š

1. âŒ **æ¥å£å®šä¹‰ä¸ä¸€è‡´**ï¼ˆæœ€ä¸¥é‡ï¼‰
2. âš ï¸ **é…ç½®ç¤ºä¾‹ä¸å®Œæ•´**
3. âš ï¸ **éƒ¨åˆ†å®ç°ç»†èŠ‚æ¨¡ç³Š**
4. âš ï¸ **ç¼ºå°‘æµ‹è¯•ç­–ç•¥**

### 9.2 ä¿®å¤å»ºè®®

**æŒ‰ä¼˜å…ˆçº§ä¿®å¤**ï¼š
1. ğŸ”´ **P0é—®é¢˜** â†’ ç«‹å³ä¿®å¤ï¼ˆ7å°æ—¶ï¼‰
2. ğŸŸ¡ **P1é—®é¢˜** â†’ æœ¬å‘¨å†…ä¿®å¤ï¼ˆ7.5å°æ—¶ï¼‰
3. ğŸŸ  **P2é—®é¢˜** â†’ ä¸‹å‘¨ä¿®å¤ï¼ˆ12å°æ—¶ï¼‰

**æ€»è®¡**: çº¦26.5å°æ—¶ï¼ˆçº¦3.5ä¸ªå·¥ä½œæ—¥ï¼‰

### 9.3 åç»­è¡ŒåŠ¨

1. **ç«‹å³è¡ŒåŠ¨**ï¼š
   - è¡¥å……ç¼ºå¤±æ¥å£åˆ°OpenAPIè§„èŒƒ
   - åˆ›å»ºå®Œæ•´çš„docker-compose.yml
   - ç¼–å†™Dockerfileå’ŒNginxé…ç½®

2. **æœ¬å‘¨å®Œæˆ**ï¼š
   - è¡¥å……ç¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹
   - å®Œå–„æ•°æ®åº“ç´¢å¼•
   - æ·»åŠ CORSé…ç½®

3. **æŒç»­æ”¹è¿›**ï¼š
   - ç¼–å†™æµ‹è¯•ç”¨ä¾‹
   - è¡¥å……è¯¦ç»†ä»£ç ç¤ºä¾‹
   - å®Œå–„ç›‘æ§å‘Šè­¦æ–¹æ¡ˆ

---

<div align="center">

**ğŸ“§ é—®é¢˜åé¦ˆ**: dev-team@your-company.com  
**ğŸ“ æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**ğŸ“… æ›´æ–°æ—¶é—´**: 2025-01-05

</div>

